

<!DOCTYPE html>


<html lang="en" >

  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="generator" content="Docutils 0.18.1: http://docutils.sourceforge.net/" />

    <title>Lab 1: Spike Sorting &#8212; Machine Learning Methods for Neural Data Analysis</title>
  
  
  
  <script data-cfasync="false">
    document.documentElement.dataset.mode = localStorage.getItem("mode") || "";
    document.documentElement.dataset.theme = localStorage.getItem("theme") || "light";
  </script>
  
  <!-- Loaded before other Sphinx assets -->
  <link href="../_static/styles/theme.css?digest=12da95d707ffb74b382d" rel="stylesheet" />
<link href="../_static/styles/bootstrap.css?digest=12da95d707ffb74b382d" rel="stylesheet" />
<link href="../_static/styles/pydata-sphinx-theme.css?digest=12da95d707ffb74b382d" rel="stylesheet" />

  
  <link href="../_static/vendor/fontawesome/6.1.2/css/all.min.css?digest=12da95d707ffb74b382d" rel="stylesheet" />
  <link rel="preload" as="font" type="font/woff2" crossorigin href="../_static/vendor/fontawesome/6.1.2/webfonts/fa-solid-900.woff2" />
<link rel="preload" as="font" type="font/woff2" crossorigin href="../_static/vendor/fontawesome/6.1.2/webfonts/fa-brands-400.woff2" />
<link rel="preload" as="font" type="font/woff2" crossorigin href="../_static/vendor/fontawesome/6.1.2/webfonts/fa-regular-400.woff2" />

    <link rel="stylesheet" type="text/css" href="../_static/pygments.css" />
    <link rel="stylesheet" href="../_static/styles/sphinx-book-theme.css?digest=14f4ca6b54d191a8c7657f6c759bf11a5fb86285" type="text/css" />
    <link rel="stylesheet" type="text/css" href="../_static/togglebutton.css" />
    <link rel="stylesheet" type="text/css" href="../_static/copybutton.css" />
    <link rel="stylesheet" type="text/css" href="../_static/mystnb.4510f1fc1dee50b3e5859aac5469c37c29e427902b24a333a5f9fcb2f0b3ac41.css" />
    <link rel="stylesheet" type="text/css" href="../_static/sphinx-thebe.css" />
    <link rel="stylesheet" type="text/css" href="../_static/design-style.4045f2051d55cab465a707391d5b2007.min.css" />
  
  <!-- Pre-loaded scripts that we'll load fully later -->
  <link rel="preload" as="script" href="../_static/scripts/bootstrap.js?digest=12da95d707ffb74b382d" />
<link rel="preload" as="script" href="../_static/scripts/pydata-sphinx-theme.js?digest=12da95d707ffb74b382d" />

    <script data-url_root="../" id="documentation_options" src="../_static/documentation_options.js"></script>
    <script src="../_static/jquery.js"></script>
    <script src="../_static/underscore.js"></script>
    <script src="../_static/_sphinx_javascript_frameworks_compat.js"></script>
    <script src="../_static/doctools.js"></script>
    <script src="../_static/clipboard.min.js"></script>
    <script src="../_static/copybutton.js"></script>
    <script src="../_static/scripts/sphinx-book-theme.js?digest=5a5c038af52cf7bc1a1ec88eea08e6366ee68824"></script>
    <script>let toggleHintShow = 'Click to show';</script>
    <script>let toggleHintHide = 'Click to hide';</script>
    <script>let toggleOpenOnPrint = 'true';</script>
    <script src="../_static/togglebutton.js"></script>
    <script>var togglebuttonSelector = '.toggle, .admonition.dropdown';</script>
    <script src="../_static/design-tabs.js"></script>
    <script>const THEBE_JS_URL = "https://unpkg.com/thebe@0.8.2/lib/index.js"
const thebe_selector = ".thebe,.cell"
const thebe_selector_input = "pre"
const thebe_selector_output = ".output, .cell_output"
</script>
    <script async="async" src="../_static/sphinx-thebe.js"></script>
    <script>window.MathJax = {"options": {"processHtmlClass": "tex2jax_process|mathjax_process|math|output_area"}}</script>
    <script defer="defer" src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
    <script>DOCUMENTATION_OPTIONS.pagename = 'labs/01_spike_sorting';</script>
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="next" title="Lab 2: Calcium Deconvolution" href="02_calcium_imaging.html" />
    <link rel="prev" title="Lab 0: PyTorch Primer" href="00_pytorch_primer.html" />
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <meta name="docsearch:language" content="en"/>
  </head>
  
  
  <body data-bs-spy="scroll" data-bs-target=".bd-toc-nav" data-offset="180" data-bs-root-margin="0px 0px -60%" data-default-mode="">

  
  
  <a class="skip-link" href="#main-content">Skip to main content</a>
  
  <input type="checkbox"
          class="sidebar-toggle"
          name="__primary"
          id="__primary"/>
  <label class="overlay overlay-primary" for="__primary"></label>
  
  <input type="checkbox"
          class="sidebar-toggle"
          name="__secondary"
          id="__secondary"/>
  <label class="overlay overlay-secondary" for="__secondary"></label>
  
  <div class="search-button__wrapper">
    <div class="search-button__overlay"></div>
    <div class="search-button__search-container">
<form class="bd-search d-flex align-items-center"
      action="../search.html"
      method="get">
  <i class="fa-solid fa-magnifying-glass"></i>
  <input type="search"
         class="form-control"
         name="q"
         id="search-input"
         placeholder="Search this book..."
         aria-label="Search this book..."
         autocomplete="off"
         autocorrect="off"
         autocapitalize="off"
         spellcheck="false"/>
  <span class="search-button__kbd-shortcut"><kbd class="kbd-shortcut__modifier">Ctrl</kbd>+<kbd>K</kbd></span>
</form></div>
  </div>
  
    <nav class="bd-header navbar navbar-expand-lg bd-navbar">
    </nav>
  
  <div class="bd-container">
    <div class="bd-container__inner bd-page-width">
      
      <div class="bd-sidebar-primary bd-sidebar">
        

  
  <div class="sidebar-header-items sidebar-primary__section">
    
    
    
    
  </div>
  
    <div class="sidebar-primary-items__start sidebar-primary__section">
        <div class="sidebar-primary-item">
  

<a class="navbar-brand logo" href="../index.html">
  
  
  
  
  
    <p class="title logo__title">Machine Learning Methods for Neural Data Analysis</p>
  
</a></div>
        <div class="sidebar-primary-item"><nav class="bd-links" id="bd-docs-nav" aria-label="Main">
    <div class="bd-toc-item navbar-nav active">
        
        <ul class="nav bd-sidenav bd-sidenav__home-link">
            <li class="toctree-l1">
                <a class="reference internal" href="../index.html">
                    Introduction
                </a>
            </li>
        </ul>
        <p aria-level="2" class="caption" role="heading"><span class="caption-text">Labs</span></p>
<ul class="current nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="00_pytorch_primer.html">Lab 0: PyTorch Primer</a></li>
<li class="toctree-l1 current active"><a class="current reference internal" href="#">Lab 1: Spike Sorting</a></li>
<li class="toctree-l1"><a class="reference internal" href="02_calcium_imaging.html">Lab 2: Calcium Deconvolution</a></li>
<li class="toctree-l1"><a class="reference internal" href="03_pose_tracking.html">Lab 3: Markerless Pose Tracking</a></li>
<li class="toctree-l1"><a class="reference internal" href="04_glms.html">Lab 4: Generalized Linear Models</a></li>
<li class="toctree-l1"><a class="reference internal" href="05_decoding.html">Lab 5: Bayesian Decoding</a></li>
<li class="toctree-l1"><a class="reference internal" href="06_arhmm.html">Lab 6: Autoregressive HMMs</a></li>
<li class="toctree-l1"><a class="reference internal" href="07_slds.html">Lab 7: Switching LDS</a></li>
</ul>
<p aria-level="2" class="caption" role="heading"><span class="caption-text">Foundations</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="../lectures/02_probabilistic_modeling.html">Probabilistic Modeling</a></li>
<li class="toctree-l1"><a class="reference internal" href="../lectures/03_neurobio.html">Basic Neurobiology</a></li>
</ul>
<p aria-level="2" class="caption" role="heading"><span class="caption-text">Unit I: Signal Extraction</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="../lectures/04_simple_spike_sorting.html">Simple Spike Sorting</a></li>
<li class="toctree-l1"><a class="reference internal" href="../lectures/05_deconv_spike_sorting.html">Spike Sorting by Deconvolution</a></li>
<li class="toctree-l1"><a class="reference internal" href="../lectures/06_calcium_imaging.html">Demixing Calcium Imaging Data</a></li>
<li class="toctree-l1"><a class="reference internal" href="../lectures/07_pose_tracking.html">Markerless Pose Tracking</a></li>
</ul>
<p aria-level="2" class="caption" role="heading"><span class="caption-text">Unit II: Encoding &amp; Decoding</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="../lectures/08_summary_stats.html">Summary Statistics</a></li>
<li class="toctree-l1"><a class="reference internal" href="../lectures/09_glm.html">Generalized Linear Models</a></li>
<li class="toctree-l1"><a class="reference internal" href="../lectures/10_poisson_processes.html">Poisson Processes</a></li>
<li class="toctree-l1"><a class="reference internal" href="../lectures/11_decoding.html">Decoding Models</a></li>
</ul>
<p aria-level="2" class="caption" role="heading"><span class="caption-text">Unit III: Unsupervised Learning</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="../lectures/12_mixtures_em.html">Mixture Models and the EM Algorithm</a></li>
<li class="toctree-l1"><a class="reference internal" href="../lectures/13_hmms.html">Hidden Markov Models</a></li>
</ul>
<p aria-level="2" class="caption" role="heading"><span class="caption-text">References</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="../lectures/99_references.html">References</a></li>
</ul>

    </div>
</nav></div>
    </div>
  
  
  <div class="sidebar-primary-items__end sidebar-primary__section">
  </div>
  
  <div id="rtd-footer-container"></div>


      </div>
      
      <main id="main-content" class="bd-main">
        
        

<div class="sbt-scroll-pixel-helper"></div>

          <div class="bd-content">
            <div class="bd-article-container">
              
              <div class="bd-header-article">
<div class="header-article-items header-article__inner">
  
    <div class="header-article-items__start">
      
        <div class="header-article-item"><label class="sidebar-toggle primary-toggle btn btn-sm" for="__primary" title="Toggle primary sidebar" data-bs-placement="bottom" data-bs-toggle="tooltip">
  <span class="fa-solid fa-bars"></span>
</label></div>
      
    </div>
  
  
    <div class="header-article-items__end">
      
        <div class="header-article-item">

<div class="article-header-buttons">





<div class="dropdown dropdown-launch-buttons">
  <button class="btn dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false" aria-label="Launch interactive content">
    <i class="fas fa-rocket"></i>
  </button>
  <ul class="dropdown-menu">
      
      
      
      <li><a href="https://colab.research.google.com/github/slinderman/stats320/blob/winter2023/labs/01_spike_sorting.ipynb" target="_blank"
   class="btn btn-sm dropdown-item"
   title="Launch onColab"
   data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  
    <img src="../_static/images/logo_colab.png">
  </span>
<span class="btn__text-container">Colab</span>
</a>
</li>
      
  </ul>
</div>






<div class="dropdown dropdown-download-buttons">
  <button class="btn dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false" aria-label="Download this page">
    <i class="fas fa-download"></i>
  </button>
  <ul class="dropdown-menu">
      
      
      
      <li><a href="../_sources/labs/01_spike_sorting.ipynb" target="_blank"
   class="btn btn-sm btn-download-source-button dropdown-item"
   title="Download source file"
   data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-file"></i>
  </span>
<span class="btn__text-container">.ipynb</span>
</a>
</li>
      
      
      
      
      <li>
<button onclick="window.print()"
  class="btn btn-sm btn-download-pdf-button dropdown-item"
  title="Print to PDF"
  data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-file-pdf"></i>
  </span>
<span class="btn__text-container">.pdf</span>
</button>
</li>
      
  </ul>
</div>




<button onclick="toggleFullScreen()"
  class="btn btn-sm btn-fullscreen-button"
  title="Fullscreen mode"
  data-bs-placement="bottom" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-expand"></i>
  </span>

</button>


<script>
document.write(`
  <button class="theme-switch-button btn btn-sm btn-outline-primary navbar-btn rounded-circle" title="light/dark" aria-label="light/dark" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <span class="theme-switch" data-mode="light"><i class="fa-solid fa-sun"></i></span>
    <span class="theme-switch" data-mode="dark"><i class="fa-solid fa-moon"></i></span>
    <span class="theme-switch" data-mode="auto"><i class="fa-solid fa-circle-half-stroke"></i></span>
  </button>
`);
</script>

<script>
document.write(`
  <button class="btn btn-sm navbar-btn search-button search-button__button" title="Search" aria-label="Search" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <i class="fa-solid fa-magnifying-glass"></i>
  </button>
`);
</script>
<label class="sidebar-toggle secondary-toggle btn btn-sm" for="__secondary"title="Toggle secondary sidebar" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <span class="fa-solid fa-list"></span>
</label>
</div></div>
      
    </div>
  
</div>
</div>
              
              

<div id="jb-print-docs-body" class="onlyprint">
    <h1>Lab 1: Spike Sorting</h1>
    <!-- Table of contents -->
    <div id="print-main-content">
        <div id="jb-print-toc">
            
            <div>
                <h2> Contents </h2>
            </div>
            <nav aria-label="Page">
                <ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#environment-setup">Environment Setup</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#helper-functions">Helper Functions</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#part-1-convolution-and-cross-correlation-with-pytorch">Part 1: Convolution and cross-correlation with PyTorch</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#problem-1a-perform-a-1d-convolution">Problem 1a: Perform a 1d convolution</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#problem-1b-perform-a-1d-cross-correlation-in-pytorch">Problem 1b: Perform a 1d cross-correlation in PyTorch</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#problem-1c-perform-a-1d-convolution-across-multiple-channels-at-once">Problem 1c: Perform a 1d convolution across multiple channels at once</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#problem-1d-perform-a-1d-cross-correlation-across-multiple-channels-at-once">Problem 1d: Perform a 1d cross-correlation across multiple channels at once</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#problem-1e-convolving-multiple-neurons-spikes-and-templates">Problem 1e: Convolving multiple neurons’ spikes and templates</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#problem-1f-perform-a-1d-cross-correlation-across-multiple-channels-and-neurons-at-once">Problem 1f: Perform a 1d cross-correlation across multiple channels and neurons at once</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#part-2-spike-sorting-by-deconvolution">Part 2: Spike sorting by deconvolution</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#simulate-some-data">Simulate some data</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#problem-2a-compute-the-log-likelihood">Problem 2a: Compute the log likelihood</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#problem-2b-compute-the-residual">Problem 2b: Compute the residual</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#problem-2c-compute-the-score">Problem 2c: Compute the score</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#problem-2d-update-the-amplitudes-using-find-peaks">Problem 2d: Update the amplitudes using <code class="docutils literal notranslate"><span class="pre">find_peaks</span></code></a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#problem-2e-update-the-templates">Problem 2e: Update the templates</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#put-it-all-together">Put it all together</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#fit-the-synthetic-data-and-plot-the-log-likelihoods">Fit the synthetic data and plot the log likelihoods</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#find-a-permutation-of-the-inferred-neurons-that-best-matches-the-true-neurons">Find a permutation of the inferred neurons that best matches the true neurons</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#plot-the-true-and-inferred-templates">Plot the true and inferred templates</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#part-3-now-do-it-more-efficiently">Part 3: Now do it more efficiently</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#problem-3a-write-helper-functions-to-up-down-date-the-residual">Problem 3a: Write helper functions to up/down-date the residual</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#problem-3b-update-the-amplitudes-using-a-fast-score-calculation">Problem 3b: Update the amplitudes using a fast score calculation</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#problem-3c-update-the-low-rank-factors-of-the-template">Problem 3c: Update the low rank factors of the template</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#id1">Put it all together</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#run-it-on-the-synthetic-data">Run it on the synthetic data</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#part-4-try-it-on-more-realistic-data">Part 4: Try it on more realistic data</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#load-preprocessed-data">Load preprocessed data</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#fit-the-model-using-the-fast-map-estimation-code-from-part-3">Fit the model using the fast MAP estimation code from Part 3</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#plot-the-inferred-templates">Plot the inferred templates</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#plot-the-data-with-inferred-spikes-overlaid">Plot the data with inferred spikes overlaid</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#part-5-short-answer">Part 5: Short Answer</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#problem-5a">Problem 5a:</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#problem-5b">Problem 5b:</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#problem-5c">Problem 5c</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#problem-5d">Problem 5d</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#submission-instructions">Submission instructions</a></li>
</ul>
            </nav>
        </div>
    </div>
</div>

              
                
<div id="searchbox"></div>
                <article class="bd-article" role="main">
                  
  <section class="tex2jax_ignore mathjax_ignore" id="lab-1-spike-sorting">
<h1>Lab 1: Spike Sorting<a class="headerlink" href="#lab-1-spike-sorting" title="Permalink to this heading">#</a></h1>
<p><strong>STATS320: Machine Learning Methods for Neural Data Analysis</strong></p>
<p><em>Stanford University. Winter, 2023.</em></p>
<hr class="docutils" />
<p><strong>Team Name:</strong> <em>Your team name here</em></p>
<p><strong>Team Members:</strong> <em>Names of everyone on your team here</em></p>
<p><em>Due: 11:59pm Thursday, Jan 26, 2023 via GradeScope (see below)</em></p>
<hr class="docutils" />
<p>This lab implements a convolutional matrix factorization model that is similar to <a class="reference external" href="https://github.com/MouseLand/Kilosort">Kilosort</a>, a state-of-the-art spike sorting package. We’ll use PyTorch to implement the key operations—convolutions and cross-correlations—on a GPU. We’ll test it on a small synthetic dataset first and then try it on a realistic dataset.</p>
<section id="environment-setup">
<h2>Environment Setup<a class="headerlink" href="#environment-setup" title="Permalink to this heading">#</a></h2>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span>%%capture
# Download some synthetic data for part 4 and solutions to check your code
!wget -nc https://www.dropbox.com/s/sg3pmrqu7wafqb7/lab1_data.pt
!wget -nc https://www.dropbox.com/s/8yal89r2ljr8ise/lab1_solutions.pt
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Import PyTorch modules</span>
<span class="kn">import</span> <span class="nn">torch</span>
<span class="kn">import</span> <span class="nn">torch.nn</span> <span class="k">as</span> <span class="nn">nn</span>
<span class="kn">import</span> <span class="nn">torch.nn.functional</span> <span class="k">as</span> <span class="nn">F</span>
<span class="kn">import</span> <span class="nn">torch.distributions</span> <span class="k">as</span> <span class="nn">dist</span>

<span class="c1"># We&#39;ll use a few functions from scipy</span>
<span class="kn">from</span> <span class="nn">scipy.signal</span> <span class="kn">import</span> <span class="n">find_peaks</span>
<span class="kn">from</span> <span class="nn">scipy.optimize</span> <span class="kn">import</span> <span class="n">linear_sum_assignment</span>

<span class="c1"># Plotting stuff</span>
<span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>
<span class="kn">from</span> <span class="nn">matplotlib.cm</span> <span class="kn">import</span> <span class="n">get_cmap</span>
<span class="kn">from</span> <span class="nn">matplotlib.gridspec</span> <span class="kn">import</span> <span class="n">GridSpec</span>
<span class="kn">import</span> <span class="nn">seaborn</span> <span class="k">as</span> <span class="nn">sns</span>

<span class="c1"># Some helper utilities</span>
<span class="kn">from</span> <span class="nn">tqdm.auto</span> <span class="kn">import</span> <span class="n">trange</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">device</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">device</span><span class="p">(</span><span class="s1">&#39;cuda&#39;</span> <span class="k">if</span> <span class="n">torch</span><span class="o">.</span><span class="n">cuda</span><span class="o">.</span><span class="n">is_available</span><span class="p">()</span> <span class="k">else</span> <span class="s1">&#39;cpu&#39;</span><span class="p">)</span>
<span class="k">if</span> <span class="ow">not</span> <span class="n">torch</span><span class="o">.</span><span class="n">cuda</span><span class="o">.</span><span class="n">is_available</span><span class="p">():</span>
    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;WARNING: THIS LAB IS BEST PERFORMED ON A MACHINE WITH A GPU!&#39;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;WARNING: IF USING COLAB, PLEASE SELECT A GPU RUNTIME!&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Load the solutions so you can check your answers</span>
<span class="c1"># NOTE: the solutions were generated with a GPU runtime</span>
<span class="c1"># If you try to load them on a CPU, it will fail. You would </span>
<span class="c1"># need to map the cuda device to the cpu.</span>
<span class="n">solutions</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="s2">&quot;lab1_solutions.pt&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
</section>
<section id="helper-functions">
<h2>Helper Functions<a class="headerlink" href="#helper-functions" title="Permalink to this heading">#</a></h2>
<div class="cell tag_hide-cell docutils container">
<details class="hide above-input">
<summary aria-label="Toggle hidden content">
<span class="collapsed">Show code cell content</span>
<span class="expanded">Hide code cell content</span>
</summary>
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1">#@title Helper functions for plotting (run this cell)</span>

<span class="c1"># initialize a color palette for plotting</span>
<span class="n">palette</span> <span class="o">=</span> <span class="n">sns</span><span class="o">.</span><span class="n">xkcd_palette</span><span class="p">([</span><span class="s2">&quot;windows blue&quot;</span><span class="p">,</span>
                            <span class="s2">&quot;red&quot;</span><span class="p">,</span>
                            <span class="s2">&quot;medium green&quot;</span><span class="p">,</span>
                            <span class="s2">&quot;dusty purple&quot;</span><span class="p">,</span>
                            <span class="s2">&quot;orange&quot;</span><span class="p">,</span>
                            <span class="s2">&quot;amber&quot;</span><span class="p">,</span>
                            <span class="s2">&quot;clay&quot;</span><span class="p">,</span>
                            <span class="s2">&quot;pink&quot;</span><span class="p">,</span>
                            <span class="s2">&quot;greyish&quot;</span><span class="p">])</span>
<span class="n">sns</span><span class="o">.</span><span class="n">set_context</span><span class="p">(</span><span class="s2">&quot;notebook&quot;</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">plot_data</span><span class="p">(</span><span class="n">timestamps</span><span class="p">,</span>
              <span class="n">data</span><span class="p">,</span> 
              <span class="n">plot_slice</span><span class="o">=</span><span class="nb">slice</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">6000</span><span class="p">),</span> 
              <span class="n">labels</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> 
              <span class="n">spike_times</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
              <span class="n">neuron_channels</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
              <span class="n">spike_width</span><span class="o">=</span><span class="mi">81</span><span class="p">,</span>
              <span class="n">scale</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span>
              <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">12</span><span class="p">,</span> <span class="mi">9</span><span class="p">),</span>
              <span class="n">cmap</span><span class="o">=</span><span class="s2">&quot;jet&quot;</span><span class="p">):</span>
    <span class="n">n_channels</span><span class="p">,</span> <span class="n">n_samples</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">shape</span>
    <span class="n">cmap</span> <span class="o">=</span> <span class="n">get_cmap</span><span class="p">(</span><span class="n">cmap</span><span class="p">)</span> <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">cmap</span><span class="p">,</span> <span class="nb">str</span><span class="p">)</span> <span class="k">else</span> <span class="n">cmap</span>
    
    <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="n">figsize</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">timestamps</span><span class="p">[</span><span class="n">plot_slice</span><span class="p">],</span> 
             <span class="n">data</span><span class="o">.</span><span class="n">T</span><span class="p">[</span><span class="n">plot_slice</span><span class="p">]</span> <span class="o">-</span> <span class="n">scale</span> <span class="o">*</span> <span class="n">torch</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">n_channels</span><span class="p">),</span> 
             <span class="s1">&#39;-k&#39;</span><span class="p">,</span> <span class="n">lw</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
    
    <span class="k">if</span> <span class="ow">not</span> <span class="nb">any</span><span class="p">(</span><span class="n">x</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="p">[</span><span class="n">labels</span><span class="p">,</span> <span class="n">spike_times</span><span class="p">,</span> <span class="n">neuron_channels</span><span class="p">]):</span>
        <span class="c1"># Plot the ground truth spikes and assignments</span>
        <span class="n">n_units</span> <span class="o">=</span> <span class="n">labels</span><span class="o">.</span><span class="n">max</span><span class="p">()</span>
        <span class="n">in_slice</span> <span class="o">=</span> <span class="p">(</span><span class="n">spike_times</span> <span class="o">&gt;=</span> <span class="n">plot_slice</span><span class="o">.</span><span class="n">start</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">spike_times</span> <span class="o">&lt;</span> <span class="n">plot_slice</span><span class="o">.</span><span class="n">stop</span><span class="p">)</span>
        <span class="n">labels</span> <span class="o">=</span> <span class="n">labels</span><span class="p">[</span><span class="n">in_slice</span><span class="p">]</span>
        <span class="n">times</span> <span class="o">=</span> <span class="n">spike_times</span><span class="p">[</span><span class="n">in_slice</span><span class="p">]</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n_units</span><span class="p">):</span>
            <span class="n">i_channels</span> <span class="o">=</span> <span class="n">neuron_channels</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
            <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">times</span><span class="p">[</span><span class="n">labels</span> <span class="o">==</span> <span class="n">i</span><span class="p">]:</span>
                <span class="n">window</span> <span class="o">=</span> <span class="nb">slice</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="n">t</span> <span class="o">+</span> <span class="n">spike_width</span><span class="p">)</span>
                <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">timestamps</span><span class="p">[</span><span class="n">window</span><span class="p">],</span> 
                         <span class="n">data</span><span class="o">.</span><span class="n">T</span><span class="p">[</span><span class="n">window</span><span class="p">,</span> <span class="n">i_channels</span><span class="p">]</span> <span class="o">-</span> <span class="n">scale</span> <span class="o">*</span> <span class="n">torch</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">n_channels</span><span class="p">)[</span><span class="n">i_channels</span><span class="p">],</span>
                         <span class="n">color</span><span class="o">=</span><span class="n">cmap</span><span class="p">(</span><span class="n">i</span> <span class="o">/</span> <span class="p">(</span><span class="n">n_units</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">numpy</span><span class="p">()),</span>
                         <span class="n">alpha</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span>
                         <span class="n">lw</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
                
    <span class="n">plt</span><span class="o">.</span><span class="n">yticks</span><span class="p">(</span><span class="o">-</span><span class="n">scale</span> <span class="o">*</span> <span class="n">torch</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">n_channels</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="n">step</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span><span class="o">.</span><span class="n">numpy</span><span class="p">(),</span> 
               <span class="n">torch</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">n_channels</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="n">step</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span><span class="o">.</span><span class="n">numpy</span><span class="p">()</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s2">&quot;time [s]&quot;</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s2">&quot;channel&quot;</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">xlim</span><span class="p">(</span><span class="n">timestamps</span><span class="p">[</span><span class="n">plot_slice</span><span class="o">.</span><span class="n">start</span><span class="p">],</span> <span class="n">timestamps</span><span class="p">[</span><span class="n">plot_slice</span><span class="o">.</span><span class="n">stop</span><span class="p">])</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">ylim</span><span class="p">(</span><span class="o">-</span><span class="n">scale</span> <span class="o">*</span> <span class="n">n_channels</span><span class="p">,</span> <span class="n">scale</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">plot_templates</span><span class="p">(</span><span class="n">templates</span><span class="p">,</span> 
                   <span class="n">indices</span><span class="p">,</span>
                   <span class="n">scale</span><span class="o">=</span><span class="mf">0.1</span><span class="p">,</span>
                   <span class="n">n_cols</span><span class="o">=</span><span class="mi">8</span><span class="p">,</span>
                   <span class="n">panel_height</span><span class="o">=</span><span class="mi">6</span><span class="p">,</span>
                   <span class="n">panel_width</span><span class="o">=</span><span class="mf">1.25</span><span class="p">,</span>
                   <span class="n">colors</span><span class="o">=</span><span class="p">(</span><span class="s1">&#39;k&#39;</span><span class="p">,),</span>
                   <span class="n">label</span><span class="o">=</span><span class="s2">&quot;neuron&quot;</span><span class="p">,</span>
                   <span class="n">sample_freq</span><span class="o">=</span><span class="mi">30000</span><span class="p">,</span>
                   <span class="n">fig</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                   <span class="n">axs</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="n">n_subplots</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">indices</span><span class="p">)</span>
    <span class="n">n_cols</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">n_cols</span><span class="p">,</span> <span class="n">n_subplots</span><span class="p">)</span>
    <span class="n">n_rows</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">ceil</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">(</span><span class="n">n_subplots</span> <span class="o">/</span> <span class="n">n_cols</span><span class="p">)))</span>

    <span class="k">if</span> <span class="n">fig</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">axs</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">fig</span><span class="p">,</span> <span class="n">axs</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">n_rows</span><span class="p">,</span> <span class="n">n_cols</span><span class="p">,</span> 
                                <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="n">panel_width</span> <span class="o">*</span> <span class="n">n_cols</span><span class="p">,</span> <span class="n">panel_height</span> <span class="o">*</span> <span class="n">n_rows</span><span class="p">),</span>
                                <span class="n">sharex</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">sharey</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    
    <span class="n">n_units</span><span class="p">,</span> <span class="n">n_channels</span><span class="p">,</span> <span class="n">spike_width</span> <span class="o">=</span> <span class="n">templates</span><span class="o">.</span><span class="n">shape</span>
    <span class="n">timestamps</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="o">-</span><span class="n">spike_width</span> <span class="o">//</span> <span class="mi">2</span><span class="p">,</span> <span class="n">spike_width</span><span class="o">//</span><span class="mi">2</span><span class="p">)</span> <span class="o">/</span> <span class="n">sample_freq</span>
    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">ind</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">indices</span><span class="p">):</span>
        <span class="n">row</span><span class="p">,</span> <span class="n">col</span> <span class="o">=</span> <span class="n">i</span> <span class="o">//</span> <span class="n">n_cols</span><span class="p">,</span> <span class="n">i</span> <span class="o">%</span> <span class="n">n_cols</span>
        <span class="n">ax</span> <span class="o">=</span> <span class="n">axs</span><span class="p">[</span><span class="n">row</span><span class="p">,</span> <span class="n">col</span><span class="p">]</span> <span class="k">if</span> <span class="n">n_rows</span> <span class="o">&gt;</span> <span class="mi">1</span> <span class="k">else</span> <span class="n">axs</span><span class="p">[</span><span class="n">col</span><span class="p">]</span>
        <span class="n">color</span> <span class="o">=</span> <span class="n">colors</span><span class="p">[</span><span class="n">i</span> <span class="o">%</span> <span class="nb">len</span><span class="p">(</span><span class="n">colors</span><span class="p">)]</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">timestamps</span> <span class="o">*</span> <span class="mi">1000</span><span class="p">,</span> 
                <span class="n">templates</span><span class="p">[</span><span class="n">ind</span><span class="p">]</span><span class="o">.</span><span class="n">T</span> <span class="o">-</span> <span class="n">scale</span> <span class="o">*</span> <span class="n">torch</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">n_channels</span><span class="p">),</span> 
                <span class="s1">&#39;-&#39;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="n">color</span><span class="p">,</span> <span class="n">lw</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        
        <span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">{}</span><span class="s2"> </span><span class="si">{:d}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">label</span><span class="p">,</span> <span class="n">ind</span> <span class="o">+</span> <span class="mi">1</span><span class="p">))</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">set_xlim</span><span class="p">(</span><span class="n">timestamps</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="mi">1000</span><span class="p">,</span> <span class="n">timestamps</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">*</span> <span class="mi">1000</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">set_yticks</span><span class="p">(</span><span class="o">-</span><span class="n">scale</span> <span class="o">*</span> <span class="n">torch</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">n_channels</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="n">step</span><span class="o">=</span><span class="mi">4</span><span class="p">))</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">set_yticklabels</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">n_channels</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="n">step</span><span class="o">=</span><span class="mi">4</span><span class="p">)</span><span class="o">.</span><span class="n">numpy</span><span class="p">()</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">set_ylim</span><span class="p">(</span><span class="o">-</span><span class="n">scale</span> <span class="o">*</span> <span class="n">n_channels</span><span class="p">,</span> <span class="n">scale</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">i</span> <span class="o">//</span> <span class="n">n_cols</span> <span class="o">==</span> <span class="n">n_rows</span> <span class="o">-</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s2">&quot;time [ms]&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">i</span> <span class="o">%</span> <span class="n">n_cols</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s2">&quot;channel&quot;</span><span class="p">)</span>

        <span class="c1"># plt.tight_layout(pad=0.1)</span>

    <span class="c1"># hide the remaining axes</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n_subplots</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">axs</span><span class="p">)):</span>
        <span class="n">row</span><span class="p">,</span> <span class="n">col</span> <span class="o">=</span> <span class="n">i</span> <span class="o">//</span> <span class="n">n_cols</span><span class="p">,</span> <span class="n">i</span> <span class="o">%</span> <span class="n">n_cols</span>
        <span class="n">ax</span> <span class="o">=</span> <span class="n">axs</span><span class="p">[</span><span class="n">row</span><span class="p">,</span> <span class="n">col</span><span class="p">]</span> <span class="k">if</span> <span class="n">n_rows</span> <span class="o">&gt;</span> <span class="mi">1</span> <span class="k">else</span> <span class="n">axs</span><span class="p">[</span><span class="n">col</span><span class="p">]</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">set_visible</span><span class="p">(</span><span class="kc">False</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">fig</span><span class="p">,</span> <span class="n">axs</span>


<span class="k">def</span> <span class="nf">plot_model</span><span class="p">(</span><span class="n">templates</span><span class="p">,</span> <span class="n">amplitude</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">scores</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">lw</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">12</span><span class="p">,</span> <span class="mi">6</span><span class="p">)):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Plot the raw data as well as the underlying signal amplitudes and templates.</span>
<span class="sd">    </span>
<span class="sd">    amplitude: (K,T) array of underlying signal amplitude</span>
<span class="sd">    template: (K,N,D) array of template that is convolved with signal</span>
<span class="sd">    data: (N, T) array (channels x time)</span>
<span class="sd">    scores: optional (K,T) array of correlations between data and template</span>
<span class="sd">    &quot;&quot;&quot;</span>    
    <span class="c1"># prepend dimension if data and template are 1d</span>
    <span class="n">data</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">atleast_2d</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
    <span class="n">N</span><span class="p">,</span> <span class="n">T</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">shape</span>
    <span class="n">amplitude</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">atleast_2d</span><span class="p">(</span><span class="n">amplitude</span><span class="p">)</span>
    <span class="n">K</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">amplitude</span><span class="o">.</span><span class="n">shape</span>
    <span class="n">templates</span> <span class="o">=</span> <span class="n">templates</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">K</span><span class="p">,</span> <span class="n">N</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">D</span> <span class="o">=</span> <span class="n">templates</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
    <span class="n">dt</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">D</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">scores</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">scores</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">atleast_2d</span><span class="p">(</span><span class="n">scores</span><span class="p">)</span>

    <span class="c1"># Set up figure with 2x2 grid of panels</span>
    <span class="n">fig</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="n">figsize</span><span class="p">)</span>
    <span class="n">gs</span> <span class="o">=</span> <span class="n">GridSpec</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="n">K</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">height_ratios</span><span class="o">=</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">],</span> <span class="n">width_ratios</span><span class="o">=</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">*</span> <span class="n">K</span> <span class="o">+</span> <span class="p">[</span><span class="mi">2</span> <span class="o">*</span> <span class="n">K</span><span class="p">])</span>

    <span class="c1"># plot the templates</span>
    <span class="n">t_spc</span> <span class="o">=</span> <span class="mf">1.05</span> <span class="o">*</span> <span class="nb">abs</span><span class="p">(</span><span class="n">templates</span><span class="p">)</span><span class="o">.</span><span class="n">max</span><span class="p">()</span>
    <span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">K</span><span class="p">):</span>
        <span class="n">ax</span> <span class="o">=</span> <span class="n">fig</span><span class="o">.</span><span class="n">add_subplot</span><span class="p">(</span><span class="n">gs</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="n">n</span><span class="p">])</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">dt</span><span class="p">,</span> <span class="n">templates</span><span class="p">[</span><span class="n">n</span><span class="p">]</span><span class="o">.</span><span class="n">T</span> <span class="o">-</span> <span class="n">t_spc</span> <span class="o">*</span> <span class="n">torch</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">N</span><span class="p">),</span> 
                <span class="s1">&#39;-&#39;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="n">palette</span><span class="p">[</span><span class="n">n</span> <span class="o">%</span> <span class="nb">len</span><span class="p">(</span><span class="n">palette</span><span class="p">)],</span> <span class="n">lw</span><span class="o">=</span><span class="n">lw</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s2">&quot;delay $d$&quot;</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">set_xlim</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span> <span class="n">D</span><span class="p">])</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">set_yticks</span><span class="p">(</span><span class="o">-</span><span class="n">t_spc</span> <span class="o">*</span> <span class="n">torch</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">N</span><span class="p">))</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">set_yticklabels</span><span class="p">([])</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">set_ylim</span><span class="p">(</span><span class="o">-</span><span class="n">N</span> <span class="o">*</span> <span class="n">t_spc</span><span class="p">,</span> <span class="n">t_spc</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">n</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s2">&quot;channels $n$&quot;</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s2">&quot;$W_{{ </span><span class="si">{}</span><span class="s2"> }}$&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">n</span><span class="o">+</span><span class="mi">1</span><span class="p">))</span>

    <span class="c1"># plot the amplitudes for each neuron</span>
    <span class="n">ax</span> <span class="o">=</span> <span class="n">fig</span><span class="o">.</span><span class="n">add_subplot</span><span class="p">(</span><span class="n">gs</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">])</span>
    <span class="n">a_spc</span> <span class="o">=</span> <span class="mf">1.05</span> <span class="o">*</span> <span class="nb">abs</span><span class="p">(</span><span class="n">amplitude</span><span class="p">)</span><span class="o">.</span><span class="n">max</span><span class="p">()</span>
    <span class="k">if</span> <span class="n">scores</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">a_spc</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">a_spc</span><span class="p">,</span> <span class="mf">1.05</span> <span class="o">*</span> <span class="nb">abs</span><span class="p">(</span><span class="n">scores</span><span class="p">)</span><span class="o">.</span><span class="n">max</span><span class="p">())</span>

    <span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">K</span><span class="p">):</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">amplitude</span><span class="p">[</span><span class="n">n</span><span class="p">]</span> <span class="o">-</span> <span class="n">a_spc</span> <span class="o">*</span> <span class="n">n</span><span class="p">,</span> <span class="s1">&#39;-&#39;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="n">palette</span><span class="p">[</span><span class="n">n</span> <span class="o">%</span> <span class="nb">len</span><span class="p">(</span><span class="n">palette</span><span class="p">)],</span> <span class="n">lw</span><span class="o">=</span><span class="n">lw</span><span class="p">)</span>
        
        <span class="k">if</span> <span class="n">scores</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">scores</span><span class="p">[</span><span class="n">n</span><span class="p">]</span> <span class="o">-</span> <span class="n">a_spc</span> <span class="o">*</span> <span class="n">n</span><span class="p">,</span> <span class="s1">&#39;:&#39;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="n">palette</span><span class="p">[</span><span class="n">n</span> <span class="o">%</span> <span class="nb">len</span><span class="p">(</span><span class="n">palette</span><span class="p">)],</span> <span class="n">lw</span><span class="o">=</span><span class="n">lw</span><span class="p">,</span>
                <span class="n">label</span><span class="o">=</span><span class="s2">&quot;$X \star W$&quot;</span><span class="p">)</span>
        
    <span class="n">ax</span><span class="o">.</span><span class="n">set_xlim</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span> <span class="n">T</span><span class="p">])</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_xticklabels</span><span class="p">([])</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_yticks</span><span class="p">(</span><span class="o">-</span><span class="n">a_spc</span> <span class="o">*</span> <span class="n">torch</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">K</span><span class="p">)</span><span class="o">.</span><span class="n">numpy</span><span class="p">())</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_yticklabels</span><span class="p">([])</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s2">&quot;neurons $k$&quot;</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s2">&quot;amplitude $a$&quot;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">scores</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>

    <span class="c1"># plot the data</span>
    <span class="n">ax</span> <span class="o">=</span> <span class="n">fig</span><span class="o">.</span><span class="n">add_subplot</span><span class="p">(</span><span class="n">gs</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">])</span>
    <span class="n">d_spc</span> <span class="o">=</span> <span class="mf">1.05</span> <span class="o">*</span> <span class="nb">abs</span><span class="p">(</span><span class="n">data</span><span class="p">)</span><span class="o">.</span><span class="n">max</span><span class="p">()</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">T</span> <span class="o">-</span> <span class="n">d_spc</span> <span class="o">*</span> <span class="n">torch</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">N</span><span class="p">),</span> <span class="s1">&#39;-&#39;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;gray&#39;</span><span class="p">,</span> <span class="n">lw</span><span class="o">=</span><span class="n">lw</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s2">&quot;time $t$&quot;</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_xlim</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span> <span class="n">T</span><span class="p">])</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_yticks</span><span class="p">(</span><span class="o">-</span><span class="n">d_spc</span> <span class="o">*</span> <span class="n">torch</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">N</span><span class="p">)</span><span class="o">.</span><span class="n">numpy</span><span class="p">())</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_yticklabels</span><span class="p">([])</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_ylim</span><span class="p">(</span><span class="o">-</span><span class="n">N</span> <span class="o">*</span> <span class="n">d_spc</span><span class="p">,</span> <span class="n">d_spc</span><span class="p">)</span>
    <span class="c1"># ax.set_ylabel(&quot;channels $c$&quot;)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s2">&quot;data $\mathbb</span><span class="si">{E}</span><span class="s2">[X]$&quot;</span><span class="p">)</span>

    <span class="c1"># plt.tight_layout()</span>
</pre></div>
</div>
</div>
</details>
</div>
<div class="cell tag_hide-cell docutils container">
<details class="hide above-input">
<summary aria-label="Toggle hidden content">
<span class="collapsed">Show code cell content</span>
<span class="expanded">Hide code cell content</span>
</summary>
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1">#@title Helper function to generate synthetic data (run this cell)</span>

<span class="k">def</span> <span class="nf">generate_templates</span><span class="p">(</span><span class="n">num_channels</span><span class="p">,</span> <span class="n">len_waveform</span><span class="p">,</span> <span class="n">num_neurons</span><span class="p">):</span>
    <span class="c1"># Make (semi) random templates</span>
    <span class="n">templates</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">num_neurons</span><span class="p">):</span>
        <span class="n">center</span> <span class="o">=</span> <span class="n">dist</span><span class="o">.</span><span class="n">Uniform</span><span class="p">(</span><span class="mf">0.0</span><span class="p">,</span> <span class="n">num_channels</span><span class="p">)</span><span class="o">.</span><span class="n">sample</span><span class="p">()</span>
        <span class="n">width</span> <span class="o">=</span> <span class="n">dist</span><span class="o">.</span><span class="n">Uniform</span><span class="p">(</span><span class="mf">1.0</span><span class="p">,</span> <span class="mf">1.0</span> <span class="o">+</span> <span class="n">num_channels</span> <span class="o">/</span> <span class="mf">10.0</span><span class="p">)</span><span class="o">.</span><span class="n">sample</span><span class="p">()</span>
        <span class="n">spatial_factor</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="mf">0.5</span> <span class="o">*</span> <span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">num_channels</span><span class="p">)</span> <span class="o">-</span> <span class="n">center</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span> <span class="o">/</span> <span class="n">width</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>
        
        <span class="n">dt</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">len_waveform</span><span class="p">)</span>
        <span class="n">period</span> <span class="o">=</span> <span class="n">len_waveform</span> <span class="o">/</span> <span class="p">(</span><span class="n">dist</span><span class="o">.</span><span class="n">Uniform</span><span class="p">(</span><span class="mf">1.0</span><span class="p">,</span> <span class="mf">2.0</span><span class="p">)</span><span class="o">.</span><span class="n">sample</span><span class="p">())</span>
        <span class="n">z</span> <span class="o">=</span> <span class="p">(</span><span class="n">dt</span> <span class="o">-</span> <span class="mf">0.75</span> <span class="o">*</span> <span class="n">period</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="mf">.25</span> <span class="o">*</span> <span class="n">period</span><span class="p">)</span>
        <span class="n">warp</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="o">-</span><span class="n">torch</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="n">x</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span>
        <span class="n">window</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="mf">0.5</span> <span class="o">*</span> <span class="n">z</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>
        <span class="n">shape</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="n">torch</span><span class="o">.</span><span class="n">pi</span> <span class="o">*</span> <span class="n">dt</span> <span class="o">/</span> <span class="n">period</span><span class="p">)</span>
        <span class="n">temporal_factor</span> <span class="o">=</span> <span class="n">warp</span><span class="p">(</span><span class="n">window</span> <span class="o">*</span> <span class="n">shape</span><span class="p">)</span>

        <span class="n">template</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">outer</span><span class="p">(</span><span class="n">spatial_factor</span><span class="p">,</span> <span class="n">temporal_factor</span><span class="p">)</span>
        <span class="n">template</span> <span class="o">/=</span> <span class="n">torch</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">template</span><span class="p">)</span>
        <span class="n">templates</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">template</span><span class="p">)</span>
    
    <span class="k">return</span> <span class="n">torch</span><span class="o">.</span><span class="n">stack</span><span class="p">(</span><span class="n">templates</span><span class="p">)</span>
    

<span class="k">def</span> <span class="nf">generate</span><span class="p">(</span><span class="n">num_timesteps</span><span class="p">,</span> 
             <span class="n">num_channels</span><span class="p">,</span> 
             <span class="n">len_waveform</span><span class="p">,</span> 
             <span class="n">num_neurons</span><span class="p">,</span> 
             <span class="n">mean_amplitude</span><span class="o">=</span><span class="mi">15</span><span class="p">,</span>
             <span class="n">shape_amplitude</span><span class="o">=</span><span class="mf">3.0</span><span class="p">,</span>
             <span class="n">noise_std</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> 
             <span class="n">sample_freq</span><span class="o">=</span><span class="mi">1000</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Create a random set of model parameters and sample data.</span>

<span class="sd">    Parameters:</span>
<span class="sd">    num_timesteps: integer number of time samples in the data</span>
<span class="sd">    num_channels: integer number of channels</span>
<span class="sd">    len_waveform: integer duration (number of samples) of each template</span>
<span class="sd">    num_neurons: integer number of neurons</span>
<span class="sd">    &quot;&quot;&quot;</span>    
    <span class="c1"># Make semi-random templates</span>
    <span class="n">templates</span> <span class="o">=</span> <span class="n">generate_templates</span><span class="p">(</span><span class="n">num_channels</span><span class="p">,</span> <span class="n">len_waveform</span><span class="p">,</span> <span class="n">num_neurons</span><span class="p">)</span>

    <span class="c1"># Make random amplitudes</span>
    <span class="n">amplitudes</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">num_neurons</span><span class="p">,</span> <span class="n">num_timesteps</span><span class="p">))</span>
    <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">num_neurons</span><span class="p">):</span>
        <span class="n">num_spikes</span> <span class="o">=</span> <span class="n">dist</span><span class="o">.</span><span class="n">Poisson</span><span class="p">(</span><span class="n">num_timesteps</span> <span class="o">/</span> <span class="n">sample_freq</span> <span class="o">*</span> <span class="mf">10.0</span><span class="p">)</span><span class="o">.</span><span class="n">sample</span><span class="p">()</span>
        <span class="n">sample_shape</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="nb">int</span><span class="p">(</span><span class="n">num_spikes</span><span class="p">),)</span>
        <span class="n">times</span> <span class="o">=</span> <span class="n">dist</span><span class="o">.</span><span class="n">Categorical</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="n">num_timesteps</span><span class="p">)</span> <span class="o">/</span> <span class="n">num_timesteps</span><span class="p">)</span><span class="o">.</span><span class="n">sample</span><span class="p">(</span><span class="n">sample_shape</span><span class="p">)</span>
        <span class="n">amps</span> <span class="o">=</span> <span class="n">dist</span><span class="o">.</span><span class="n">Gamma</span><span class="p">(</span><span class="n">shape_amplitude</span><span class="p">,</span> <span class="n">shape_amplitude</span> <span class="o">/</span> <span class="n">mean_amplitude</span><span class="p">)</span><span class="o">.</span><span class="n">sample</span><span class="p">(</span><span class="n">sample_shape</span><span class="p">)</span>
        <span class="n">amplitudes</span><span class="p">[</span><span class="n">k</span><span class="p">,</span> <span class="n">times</span><span class="p">]</span> <span class="o">=</span> <span class="n">amps</span>

        <span class="c1"># Only keep spikes separated by at least D</span>
        <span class="n">times</span><span class="p">,</span> <span class="n">props</span> <span class="o">=</span> <span class="n">find_peaks</span><span class="p">(</span><span class="n">amplitudes</span><span class="p">[</span><span class="n">k</span><span class="p">],</span> <span class="n">distance</span><span class="o">=</span><span class="n">len_waveform</span><span class="p">,</span> <span class="n">height</span><span class="o">=</span><span class="mf">1e-3</span><span class="p">)</span>
        <span class="n">amplitudes</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">amplitudes</span><span class="p">[</span><span class="n">k</span><span class="p">,</span> <span class="n">times</span><span class="p">]</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">(</span><span class="n">props</span><span class="p">[</span><span class="s1">&#39;peak_heights&#39;</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">torch</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>

    <span class="c1"># Convolve the signal with each row of the multi-channel template</span>
    <span class="n">data</span> <span class="o">=</span> <span class="n">F</span><span class="o">.</span><span class="n">conv1d</span><span class="p">(</span><span class="n">amplitudes</span><span class="o">.</span><span class="n">unsqueeze</span><span class="p">(</span><span class="mi">0</span><span class="p">),</span>
                    <span class="n">templates</span><span class="o">.</span><span class="n">permute</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span><span class="o">.</span><span class="n">flip</span><span class="p">(</span><span class="n">dims</span><span class="o">=</span><span class="p">(</span><span class="mi">2</span><span class="p">,)),</span>
                    <span class="n">padding</span><span class="o">=</span><span class="n">len_waveform</span><span class="o">-</span><span class="mi">1</span><span class="p">)[</span><span class="mi">0</span><span class="p">,</span> <span class="p">:,</span> <span class="p">:</span><span class="o">-</span><span class="p">(</span><span class="n">len_waveform</span><span class="o">-</span><span class="mi">1</span><span class="p">)]</span>
    
    <span class="n">data</span> <span class="o">+=</span> <span class="n">dist</span><span class="o">.</span><span class="n">Normal</span><span class="p">(</span><span class="mf">0.0</span><span class="p">,</span> <span class="n">noise_std</span><span class="p">)</span><span class="o">.</span><span class="n">sample</span><span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">templates</span><span class="p">,</span> <span class="n">amplitudes</span><span class="p">,</span> <span class="n">data</span>
</pre></div>
</div>
</div>
</details>
</div>
</section>
<section id="part-1-convolution-and-cross-correlation-with-pytorch">
<h2>Part 1: Convolution and cross-correlation with PyTorch<a class="headerlink" href="#part-1-convolution-and-cross-correlation-with-pytorch" title="Permalink to this heading">#</a></h2>
<p>One of the main advantages of PyTorch over Numpy/Scipy is that it allows us to use hardware accelerators like GPUs. PyTorch tensors are stored on a specified device, and in the setup above you’ll see that we specified our device to be <code class="docutils literal notranslate"><span class="pre">'cuda'</span></code>, i.e. a GPU. Google Colab gives you free access to a GPU machine, as long as you select the GPU runtime. If you click the RAM/disk icon in the upper right, you should see that this session is a GPU session. If it’s not, go to “Runtime -&gt; Change Runtime Type” to select a GPU.</p>
<p><code class="docutils literal notranslate"><span class="pre">Tensor</span></code> objects have a few nice functions that will make your life easier in this lab. Suppose <code class="docutils literal notranslate"><span class="pre">data</span></code> is a <code class="docutils literal notranslate"><span class="pre">Tensor</span></code>. Then,</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">data.flip(dims=(-1,))</span></code> flips the tensor along its last axis.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">data.unsqueeze(0)</span></code> creates a new leading axis.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">data.permute(1,</span> <span class="pre">0,</span> <span class="pre">2)</span></code> permutes the order of the axes.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">data.reshape(1,</span> <span class="pre">1,</span> <span class="pre">-1)</span></code> vectorizes the data and reshapes it to have two leading dimensions, each of length 1.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">data.sum()</span></code> sums the entries in the data.</p></li>
</ul>
<p>If this is your first time using PyTorch and you get stuck, you might want to go back to <a class="reference internal" href="00_pytorch_primer.html"><span class="doc std std-doc">Lab 0: PyTorch Primer</span></a>.</p>
<section id="problem-1a-perform-a-1d-convolution">
<h3>Problem 1a: Perform a 1d convolution<a class="headerlink" href="#problem-1a-perform-a-1d-convolution" title="Permalink to this heading">#</a></h3>
<p>As a first step, we generate synthetic data with a single neuron and a single channel. Based on a template and a 1d array representing amplitudes for the single neuron, we simulate data as the convolution of these two arrays.</p>
<p>You’ll use the <code class="docutils literal notranslate"><span class="pre">conv1d</span></code> function in the <code class="docutils literal notranslate"><span class="pre">torch.nn.functional</span></code> package. We’ve already imported that package with the shorthand name <code class="docutils literal notranslate"><span class="pre">F</span></code> so that you can call the function with <code class="docutils literal notranslate"><span class="pre">F.conv1d(...)</span></code>. Take a look at its documentation <a class="reference external" href="https://pytorch.org/docs/stable/nn.functional.html?highlight=conv1d#torch.nn.functional.conv1d">here</a>, as well as the corresponding documentation for the <code class="docutils literal notranslate"><span class="pre">torch.nn.Conv1d</span></code> object, which implements a convolutional layer for a neural network.</p>
<p>Here’s an example,</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1"># make the input (i.e. the signal)</span>
<span class="n">B</span> <span class="o">=</span> <span class="mi">1</span>   <span class="c1"># batch size</span>
<span class="n">K</span> <span class="o">=</span> <span class="mi">2</span>   <span class="c1"># number of input channels</span>
<span class="n">T</span> <span class="o">=</span> <span class="mi">100</span> <span class="c1"># length of input signal</span>
<span class="nb">input</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">rand</span><span class="p">(</span><span class="n">B</span><span class="p">,</span> <span class="n">K</span><span class="p">,</span> <span class="n">T</span><span class="p">)</span>

<span class="c1"># make the weights (i.e. the filter)</span>
<span class="n">N</span> <span class="o">=</span> <span class="mi">3</span>   <span class="c1"># number of output channels</span>
<span class="n">D</span> <span class="o">=</span> <span class="mi">10</span>  <span class="c1"># length of the filter</span>
<span class="n">weight</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">rand</span><span class="p">(</span><span class="n">N</span><span class="p">,</span> <span class="n">K</span><span class="p">,</span> <span class="n">D</span><span class="p">)</span>

<span class="c1"># perform the convolution</span>
<span class="n">output</span> <span class="o">=</span> <span class="n">F</span><span class="o">.</span><span class="n">conv1d</span><span class="p">(</span><span class="nb">input</span><span class="p">,</span> <span class="n">weight</span><span class="p">)</span>

<span class="c1"># output.shape is (B, N, T - D + 1)</span>
</pre></div>
</div>
<p><strong>Remember that <code class="docutils literal notranslate"><span class="pre">conv1d</span></code> actually performs a cross-correlation!</strong></p>
<p>Let <span class="math notranslate nohighlight">\(\mathbf{A} \in \mathbb{R}^{B \times K \times T}\)</span> denote the signal/input and <span class="math notranslate nohighlight">\(\mathbf{W} \in \mathbb{R}^{N \times K \times D}\)</span> denote the filter/weights (note that the axes are permuted relative to our mathematical notes), and let <span class="math notranslate nohighlight">\(\mathbf{X} \in \mathbb{R}^{B \times N \times T - D + 1}\)</span> denote the output. Then the <code class="docutils literal notranslate"><span class="pre">conv1d</span></code> function implements the cross-correlation,</p>
<div class="math notranslate nohighlight">
\[
\begin{align*}
x_{b,n,t} = \sum_{k = 1}^{K} \sum_{d=1}^D a_{b,k,t+d-1} w_{n,k,d}.
\end{align*}
\]</div>
<p>for <span class="math notranslate nohighlight">\(b=1,\ldots,B\)</span>, <span class="math notranslate nohighlight">\(n=1,\ldots,N\)</span>, and <span class="math notranslate nohighlight">\(t=1,\ldots,T-D+1\)</span>.</p>
<p>By default the output only contains the “valid” portion of the convolution; i.e. the <span class="math notranslate nohighlight">\(T-D+1\)</span> samples where the inputs and weights completely overlap. If you want the “full” output, you have to call <code class="docutils literal notranslate"><span class="pre">F.conv1d(input,</span> <span class="pre">weights,</span> <span class="pre">padding=D-1)</span></code>. This pads the input with <span class="math notranslate nohighlight">\(D-1\)</span> zeros at the beginning and end so that the resulting output is length <span class="math notranslate nohighlight">\(T + D - 1\)</span>. Depending your application, you may want the first <span class="math notranslate nohighlight">\(T\)</span> or the last <span class="math notranslate nohighlight">\(T\)</span> entries in this array. When in doubt, try both and see!</p>
<p>Use <code class="docutils literal notranslate"><span class="pre">conv1d</span></code> to implement a 1d <strong>convolution</strong>. Remember that you can do it by cross-correlation as long as you flip your weights along the last axis.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Create a dataset with a single channel and one neuron.</span>
<span class="n">T</span> <span class="o">=</span> <span class="mi">1000</span>    <span class="c1"># number of time samples</span>
<span class="n">K</span> <span class="o">=</span> <span class="mi">1</span>       <span class="c1"># one neuron</span>
<span class="n">N</span> <span class="o">=</span> <span class="mi">1</span>       <span class="c1"># number of channels</span>
<span class="n">D</span> <span class="o">=</span> <span class="mi">51</span>      <span class="c1"># duration of a spike (in samples)</span>

<span class="c1"># Generate random templates, amplitudes, and noisy data.</span>
<span class="c1"># `templates` are KxNxD and `amplitudes` are KxT</span>
<span class="n">torch</span><span class="o">.</span><span class="n">manual_seed</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
<span class="n">templates</span><span class="p">,</span> <span class="n">amplitudes</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">generate</span><span class="p">(</span><span class="n">T</span><span class="p">,</span> <span class="n">N</span><span class="p">,</span> <span class="n">D</span><span class="p">,</span> <span class="n">K</span><span class="p">)</span>

<span class="c1">###</span>
<span class="c1"># Now perform the same convolution using PyTorch&#39;s `conv1d` function.</span>
<span class="c1"># YOUR CODE BELOW</span>

<span class="c1"># data = F.conv1d(...)</span>

<span class="c1">#</span>
<span class="c1">##</span>

<span class="c1"># Your answer should look like this</span>
<span class="n">plot_model</span><span class="p">(</span><span class="n">templates</span><span class="p">,</span> <span class="n">amplitudes</span><span class="p">,</span> <span class="n">solutions</span><span class="p">[</span><span class="s2">&quot;1a&quot;</span><span class="p">])</span>
<span class="k">assert</span> <span class="n">torch</span><span class="o">.</span><span class="n">allclose</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">solutions</span><span class="p">[</span><span class="s2">&quot;1a&quot;</span><span class="p">],</span> <span class="n">atol</span><span class="o">=</span><span class="mf">1e-4</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../_images/f5884497c8e2816bf36ab7d056e689d253b8f5fcbe360f543c86d1eecd75f5e6.png" src="../_images/f5884497c8e2816bf36ab7d056e689d253b8f5fcbe360f543c86d1eecd75f5e6.png" />
</div>
</div>
</section>
<section id="problem-1b-perform-a-1d-cross-correlation-in-pytorch">
<h3>Problem 1b: Perform a 1d cross-correlation in PyTorch<a class="headerlink" href="#problem-1b-perform-a-1d-cross-correlation-in-pytorch" title="Permalink to this heading">#</a></h3>
<p>Remember that the cross-correlation measures the similarity between the template and the actual data at every time window. In those time points where the data and the template coincide, we should obtain a high correlation indicating the presence of a spike. The peaks of the amplitude array and the cross-correlation array should match, as you see in the plot below.  The dotted line shows the cross-correlation of the data and the template, and we see that it peaks where there are spikes in the true underlying amplitude that generated the data.</p>
<p>Use <code class="docutils literal notranslate"><span class="pre">conv1d</span></code> to implement this <strong>cross-correlation</strong> and get the dotted line.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1">###</span>
<span class="c1"># Perform the cross-correlation using PyTorch&#39;s `conv1d` function.</span>
<span class="c1"># YOUR CODE BELOW</span>

<span class="c1"># score = F.conv1d(...)</span>

<span class="c1">#</span>
<span class="c1">##</span>

<span class="c1"># Your answer should look like this</span>
<span class="n">plot_model</span><span class="p">(</span><span class="n">templates</span><span class="p">,</span> <span class="n">amplitudes</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">scores</span><span class="o">=</span><span class="n">solutions</span><span class="p">[</span><span class="s2">&quot;1b&quot;</span><span class="p">])</span>
<span class="k">assert</span> <span class="n">torch</span><span class="o">.</span><span class="n">allclose</span><span class="p">(</span><span class="n">score</span><span class="p">,</span> <span class="n">solutions</span><span class="p">[</span><span class="s2">&quot;1b&quot;</span><span class="p">],</span> <span class="n">atol</span><span class="o">=</span><span class="mf">1e-4</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../_images/f4bf56b263333b868729968f78af4464a903462fc1c79461b83c93fb2c9d6c08.png" src="../_images/f4bf56b263333b868729968f78af4464a903462fc1c79461b83c93fb2c9d6c08.png" />
</div>
</div>
</section>
<section id="problem-1c-perform-a-1d-convolution-across-multiple-channels-at-once">
<h3>Problem 1c: Perform a 1d convolution across multiple channels at once<a class="headerlink" href="#problem-1c-perform-a-1d-convolution-across-multiple-channels-at-once" title="Permalink to this heading">#</a></h3>
<p>Similar to problem 1a, except that the template (and therefore the final synthetic data) has multiple <em>output</em> channels.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Create a dataset with a many channels but one neuron.</span>
<span class="n">T</span> <span class="o">=</span> <span class="mi">1000</span>    <span class="c1"># number of time samples</span>
<span class="n">N</span> <span class="o">=</span> <span class="mi">10</span>      <span class="c1"># number of channels</span>
<span class="n">D</span> <span class="o">=</span> <span class="mi">100</span>     <span class="c1"># duration of a spike (in samples)</span>
<span class="n">K</span> <span class="o">=</span> <span class="mi">1</span>       <span class="c1"># one neuron</span>

<span class="c1"># Generate random templates, amplitudes, and noisy data.</span>
<span class="c1"># `templates` are KxNxD and `amplitudes` are KxT</span>
<span class="n">torch</span><span class="o">.</span><span class="n">manual_seed</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
<span class="n">templates</span><span class="p">,</span> <span class="n">amplitudes</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">generate</span><span class="p">(</span><span class="n">T</span><span class="p">,</span> <span class="n">N</span><span class="p">,</span> <span class="n">D</span><span class="p">,</span> <span class="n">K</span><span class="p">)</span>

<span class="c1">###</span>
<span class="c1"># Now perform the same convolution using PyTorch&#39;s `conv1d` function.</span>
<span class="c1"># YOUR CODE BELOW</span>

<span class="c1"># data = F.conv1d(...)</span>

<span class="c1">###</span>

<span class="c1"># Your solution shold look like this </span>
<span class="n">plot_model</span><span class="p">(</span><span class="n">templates</span><span class="p">,</span> <span class="n">amplitudes</span><span class="p">,</span> <span class="n">solutions</span><span class="p">[</span><span class="s2">&quot;1c&quot;</span><span class="p">])</span>
<span class="k">assert</span> <span class="n">torch</span><span class="o">.</span><span class="n">allclose</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">solutions</span><span class="p">[</span><span class="s2">&quot;1c&quot;</span><span class="p">],</span> <span class="n">atol</span><span class="o">=</span><span class="mf">1e-4</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../_images/4e7bab9a0682e8bd0bce4a2824a8bcf8a3a087831f265921602f3403b092d6ec.png" src="../_images/4e7bab9a0682e8bd0bce4a2824a8bcf8a3a087831f265921602f3403b092d6ec.png" />
</div>
</div>
</section>
<section id="problem-1d-perform-a-1d-cross-correlation-across-multiple-channels-at-once">
<h3>Problem 1d: Perform a 1d cross-correlation across multiple channels at once<a class="headerlink" href="#problem-1d-perform-a-1d-cross-correlation-across-multiple-channels-at-once" title="Permalink to this heading">#</a></h3>
<p>Same as Problem 1b except that the data and templates have multiple <em>input</em> channels.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1">###</span>
<span class="c1"># Perform the cross-correlation using PyTorch&#39;s </span>
<span class="c1"># ``nn.functional.conv1d` function. You should only need </span>
<span class="c1"># one call to this function!</span>
<span class="c1">#</span>
<span class="c1"># YOUR CODE BELOW</span>
<span class="c1"># score = F.conv1d(...)</span>

<span class="c1">### </span>

<span class="n">plot_model</span><span class="p">(</span><span class="n">templates</span><span class="p">,</span> <span class="n">amplitudes</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">scores</span><span class="o">=</span><span class="n">solutions</span><span class="p">[</span><span class="s2">&quot;1d&quot;</span><span class="p">])</span>
<span class="k">assert</span> <span class="n">torch</span><span class="o">.</span><span class="n">allclose</span><span class="p">(</span><span class="n">score</span><span class="p">,</span> <span class="n">solutions</span><span class="p">[</span><span class="s2">&quot;1d&quot;</span><span class="p">],</span> <span class="n">atol</span><span class="o">=</span><span class="mf">1e-4</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../_images/02c0eb7f0b008eb06f17aa074db55ca7927ed7aae2c2d3371da98e12dc58c0ed.png" src="../_images/02c0eb7f0b008eb06f17aa074db55ca7927ed7aae2c2d3371da98e12dc58c0ed.png" />
</div>
</div>
</section>
<section id="problem-1e-convolving-multiple-neurons-spikes-and-templates">
<h3>Problem 1e: Convolving multiple neurons’ spikes and templates<a class="headerlink" href="#problem-1e-convolving-multiple-neurons-spikes-and-templates" title="Permalink to this heading">#</a></h3>
<p>Similar to problem 1c, but here we have multiple neurons (input channels), each associated to a template with multiple (output) channels. The final simulated data is aggregated across neurons to simulate actual measurements where signals from multiple neurons are superimposed.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Create a dataset with a multiple channels and neurons.</span>
<span class="n">T</span> <span class="o">=</span> <span class="mi">1000</span>    <span class="c1"># number of time samples</span>
<span class="n">N</span> <span class="o">=</span> <span class="mi">10</span>      <span class="c1"># number of channels</span>
<span class="n">D</span> <span class="o">=</span> <span class="mi">100</span>     <span class="c1"># duration of a spike (in samples)</span>
<span class="n">K</span> <span class="o">=</span> <span class="mi">3</span>       <span class="c1"># multiple neuron</span>

<span class="c1"># Generate random templates, amplitudes, and noisy data.</span>
<span class="c1"># `templates` are KxNxD and `amplitudes` are KxT</span>
<span class="n">torch</span><span class="o">.</span><span class="n">manual_seed</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
<span class="n">templates</span><span class="p">,</span> <span class="n">amplitudes</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">generate</span><span class="p">(</span><span class="n">T</span><span class="p">,</span> <span class="n">N</span><span class="p">,</span> <span class="n">D</span><span class="p">,</span> <span class="n">K</span><span class="p">)</span>

<span class="c1">###</span>
<span class="c1"># Perform the convolution using PyTorch&#39;s `conv1d` function. </span>
<span class="c1"># One call to `F.conv1d` should perform the sum over neurons for you.</span>
<span class="c1"># YOUR CODE BELOW</span>

<span class="c1"># data = F.conv1d(...)</span>

<span class="c1">###</span>

<span class="n">plot_model</span><span class="p">(</span><span class="n">templates</span><span class="p">,</span> <span class="n">amplitudes</span><span class="p">,</span> <span class="n">solutions</span><span class="p">[</span><span class="s2">&quot;1e&quot;</span><span class="p">])</span>
<span class="k">assert</span> <span class="n">torch</span><span class="o">.</span><span class="n">allclose</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">solutions</span><span class="p">[</span><span class="s2">&quot;1e&quot;</span><span class="p">],</span> <span class="n">atol</span><span class="o">=</span><span class="mf">1e-4</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../_images/5dd5cbe3937783b9c21a022f4984e4c9f92bf80406880b00b9e20cdebe4f064a.png" src="../_images/5dd5cbe3937783b9c21a022f4984e4c9f92bf80406880b00b9e20cdebe4f064a.png" />
</div>
</div>
</section>
<section id="problem-1f-perform-a-1d-cross-correlation-across-multiple-channels-and-neurons-at-once">
<h3>Problem 1f: Perform a 1d cross-correlation across multiple channels and neurons at once<a class="headerlink" href="#problem-1f-perform-a-1d-cross-correlation-across-multiple-channels-and-neurons-at-once" title="Permalink to this heading">#</a></h3>
<p>Same as Problem 1c but now we’re performing the cross-correlation with multiple neurons’ templates at once.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1">###</span>
<span class="c1"># Perform the convolution using PyTorch&#39;s `conv1d` function. </span>
<span class="c1"># One call to `F.conv1d` should perform all cross-correlations for you.</span>
<span class="c1"># YOUR CODE BELOW</span>
<span class="c1">#</span>

<span class="c1"># score = F.conv1d(...)</span>

<span class="c1">###</span>

<span class="c1"># Your answer should look like this</span>
<span class="n">plot_model</span><span class="p">(</span><span class="n">templates</span><span class="p">,</span> <span class="n">amplitudes</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">scores</span><span class="o">=</span><span class="n">solutions</span><span class="p">[</span><span class="s2">&quot;1f&quot;</span><span class="p">])</span>
<span class="k">assert</span> <span class="n">torch</span><span class="o">.</span><span class="n">allclose</span><span class="p">(</span><span class="n">score</span><span class="p">,</span> <span class="n">solutions</span><span class="p">[</span><span class="s2">&quot;1f&quot;</span><span class="p">],</span> <span class="n">atol</span><span class="o">=</span><span class="mf">1e-4</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../_images/eb7e93603f848f93215fe195019b85d2ac47af5f8107455118db482ff29fd391.png" src="../_images/eb7e93603f848f93215fe195019b85d2ac47af5f8107455118db482ff29fd391.png" />
</div>
</div>
</section>
</section>
<section id="part-2-spike-sorting-by-deconvolution">
<h2>Part 2: Spike sorting by deconvolution<a class="headerlink" href="#part-2-spike-sorting-by-deconvolution" title="Permalink to this heading">#</a></h2>
<p>In this part of the lab you’ll use those cross-correlation and convolution operations to implement the spike sorting algorithm we discussed in class. We’ll work with a synthetic dataset, as above, but this time we’ll make it slightly larger.  (It’s still a lot smaller than the dataset we used in Lab 1 though!)</p>
<section id="simulate-some-data">
<h3>Simulate some data<a class="headerlink" href="#simulate-some-data" title="Permalink to this heading">#</a></h3>
<p>No coding necessary here. We’re just simulating the data for you.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Create a larger dataset with a multiple channels and neurons.</span>
<span class="n">T</span> <span class="o">=</span> <span class="mi">1000000</span> <span class="c1"># number of time samples</span>
<span class="n">N</span> <span class="o">=</span> <span class="mi">32</span>      <span class="c1"># number of channels</span>
<span class="n">D</span> <span class="o">=</span> <span class="mi">81</span>      <span class="c1"># duration of a spike (in samples)</span>
<span class="n">K</span> <span class="o">=</span> <span class="mi">10</span>      <span class="c1"># multiple neurons</span>

<span class="c1"># Generate random templates, amplitudes, and noisy data.</span>
<span class="c1"># `templates` are NxCxD and `amplitudes` are NxT</span>
<span class="n">torch</span><span class="o">.</span><span class="n">manual_seed</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Simulating data. This could take a few seconds!&quot;</span><span class="p">)</span>
<span class="n">true_templates</span><span class="p">,</span> <span class="n">true_amplitudes</span><span class="p">,</span> <span class="n">data</span> <span class="o">=</span> <span class="n">generate</span><span class="p">(</span><span class="n">T</span><span class="p">,</span> <span class="n">N</span><span class="p">,</span> <span class="n">D</span><span class="p">,</span> <span class="n">K</span><span class="p">)</span>
<span class="n">plot_model</span><span class="p">(</span><span class="n">true_templates</span><span class="p">,</span> <span class="n">true_amplitudes</span><span class="p">[:,</span> <span class="p">:</span><span class="mi">2000</span><span class="p">],</span> <span class="n">data</span><span class="p">[:,:</span><span class="mi">2000</span><span class="p">],</span> 
           <span class="n">lw</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">12</span><span class="p">,</span> <span class="mi">8</span><span class="p">))</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Simulating data. This could take a few seconds!
</pre></div>
</div>
<img alt="../_images/e5d2f8dd4ac9ad4a2d80431d26bcc15dd295233b7eabf146944cea1d11729122.png" src="../_images/e5d2f8dd4ac9ad4a2d80431d26bcc15dd295233b7eabf146944cea1d11729122.png" />
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Generate another set of random templates and amplitudes to seed the model</span>
<span class="n">torch</span><span class="o">.</span><span class="n">manual_seed</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
<span class="n">templates</span> <span class="o">=</span> <span class="n">generate_templates</span><span class="p">(</span><span class="n">N</span><span class="p">,</span> <span class="n">D</span><span class="p">,</span> <span class="n">K</span><span class="p">)</span>
<span class="n">amplitudes</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">K</span><span class="p">,</span> <span class="n">T</span><span class="p">))</span>
<span class="n">noise_std</span> <span class="o">=</span> <span class="mf">1.0</span>

<span class="c1"># Copy the tensors to the GPU (if available)</span>
<span class="n">templates</span> <span class="o">=</span> <span class="n">templates</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">device</span><span class="p">)</span>
<span class="n">amplitudes</span> <span class="o">=</span> <span class="n">amplitudes</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">device</span><span class="p">)</span>
<span class="n">data</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">device</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
</section>
<section id="problem-2a-compute-the-log-likelihood">
<h3>Problem 2a: Compute the log likelihood<a class="headerlink" href="#problem-2a-compute-the-log-likelihood" title="Permalink to this heading">#</a></h3>
<p>One of the most awesome features of PyTorch is its <code class="docutils literal notranslate"><span class="pre">torch.distributions</span></code> package. See the docs <a class="reference external" href="https://pytorch.org/docs/stable/distributions.html">here</a>. It contains objects for many of our favorite distributions, and has convenient functions for computing log probabilities (with <code class="docutils literal notranslate"><span class="pre">d.log_prob()</span></code> where <code class="docutils literal notranslate"><span class="pre">d</span></code> is a <code class="docutils literal notranslate"><span class="pre">Distribution</span></code> object), sampling (<code class="docutils literal notranslate"><span class="pre">d.sample()</span></code>), computing the entropy (<code class="docutils literal notranslate"><span class="pre">d.entropy()</span></code>), etc. These functions broadcast as you’d expect (unlike <code class="docutils literal notranslate"><span class="pre">scipy.stats</span></code>!), and they’re designed to work with automatic differentiation.  More on that another day…</p>
<p>For now, you’ll use <code class="docutils literal notranslate"><span class="pre">dist.Normal</span></code> to compute the log likelihood of the data given the template and amplitudes, <span class="math notranslate nohighlight">\(\log p(\mathbf{X} \mid \mathbf{A}, \mathbf{W})\)</span>.  To do that, you’ll convolve the amplitudes and templates (recall Problem 1e) to get the mean value of <span class="math notranslate nohighlight">\(\mathbf{X}\)</span>, then you’ll use the <code class="docutils literal notranslate"><span class="pre">log_prob</span></code> function to evaluate the likelihood of the data.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">log_likelihood</span><span class="p">(</span><span class="n">templates</span><span class="p">,</span> <span class="n">amplitudes</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">noise_std</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Evaluate the log likelihood&quot;&quot;&quot;</span>
    <span class="n">K</span><span class="p">,</span> <span class="n">N</span><span class="p">,</span> <span class="n">D</span> <span class="o">=</span> <span class="n">templates</span><span class="o">.</span><span class="n">shape</span>
    <span class="n">_</span><span class="p">,</span> <span class="n">T</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">shape</span>
    
    <span class="c1">### </span>
    <span class="c1"># YOUR CODE BELOW</span>
    
    <span class="c1"># Compute the model prediction by convolving the amplitude and templates</span>
    <span class="c1"># pred = F.conv1d(...)</span>

    <span class="c1"># Evaluate the log probability using dist.Normal</span>
    <span class="c1"># ll = ...</span>
    
    <span class="c1">###  </span>

    <span class="c1"># Return the log probability normalized by the data size</span>
    <span class="k">return</span> <span class="n">ll</span> <span class="o">/</span> <span class="p">(</span><span class="n">N</span> <span class="o">*</span> <span class="n">T</span><span class="p">)</span>

<span class="n">ll</span> <span class="o">=</span> <span class="n">log_likelihood</span><span class="p">(</span><span class="n">templates</span><span class="p">,</span> <span class="n">amplitudes</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">noise_std</span><span class="p">)</span>
<span class="k">assert</span> <span class="n">ll</span><span class="o">.</span><span class="n">isclose</span><span class="p">(</span><span class="n">solutions</span><span class="p">[</span><span class="s2">&quot;2a&quot;</span><span class="p">],</span> <span class="n">atol</span><span class="o">=</span><span class="mf">1e-4</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
</section>
<section id="problem-2b-compute-the-residual">
<h3>Problem 2b: Compute the residual<a class="headerlink" href="#problem-2b-compute-the-residual" title="Permalink to this heading">#</a></h3>
<p>Next, compute the residual for a specified neuron by subtracting the convolved amplitudes and templates for all the other neurons. Again, recall Problem 1e.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">compute_residual</span><span class="p">(</span><span class="n">neuron</span><span class="p">,</span> <span class="n">templates</span><span class="p">,</span> <span class="n">amplitudes</span><span class="p">,</span> <span class="n">data</span><span class="p">):</span>
    <span class="n">K</span><span class="p">,</span> <span class="n">C</span><span class="p">,</span> <span class="n">D</span> <span class="o">=</span> <span class="n">templates</span><span class="o">.</span><span class="n">shape</span>

    <span class="c1">###</span>
    <span class="c1"># Compute the predicted value of the data by </span>
    <span class="c1"># convolving the amplitudes and the templates for all</span>
    <span class="c1"># neurons except the specified one.</span>
    <span class="c1">#</span>
    <span class="c1"># YOUR CODE BELOW</span>
    <span class="n">not_n</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">cat</span><span class="p">([</span><span class="n">torch</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">neuron</span><span class="p">),</span> <span class="n">torch</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">neuron</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="n">K</span><span class="p">)])</span>
    <span class="c1"># pred = F.conv1d(...)</span>
    
    <span class="c1">###</span>

    <span class="c1"># Return the data minus the predicted value given other neurons</span>
    <span class="k">return</span> <span class="n">data</span> <span class="o">-</span> <span class="n">pred</span>

<span class="n">residual</span> <span class="o">=</span> <span class="n">compute_residual</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">templates</span><span class="p">,</span> <span class="n">amplitudes</span><span class="p">,</span> <span class="n">data</span><span class="p">)</span>
<span class="k">assert</span> <span class="n">residual</span><span class="p">[</span><span class="mi">16</span><span class="p">,</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1234</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">]]</span><span class="o">.</span><span class="n">allclose</span><span class="p">(</span><span class="n">solutions</span><span class="p">[</span><span class="s2">&quot;2b&quot;</span><span class="p">],</span> <span class="n">atol</span><span class="o">=</span><span class="mf">1e-4</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
</section>
<section id="problem-2c-compute-the-score">
<h3>Problem 2c: Compute the score<a class="headerlink" href="#problem-2c-compute-the-score" title="Permalink to this heading">#</a></h3>
<p>Let the “score” for neuron <span class="math notranslate nohighlight">\(k\)</span> be the cross-correlation of the residual and its template. Compute it using <code class="docutils literal notranslate"><span class="pre">conv1d</span></code>. Recall Problem 1d.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">compute_score</span><span class="p">(</span><span class="n">neuron</span><span class="p">,</span> <span class="n">templates</span><span class="p">,</span> <span class="n">amplitudes</span><span class="p">,</span> <span class="n">data</span><span class="p">):</span>
    <span class="n">K</span><span class="p">,</span> <span class="n">N</span><span class="p">,</span> <span class="n">D</span> <span class="o">=</span> <span class="n">templates</span><span class="o">.</span><span class="n">shape</span>
    <span class="n">T</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>

    <span class="c1"># First get the residual</span>
    <span class="n">residual</span> <span class="o">=</span> <span class="n">compute_residual</span><span class="p">(</span><span class="n">neuron</span><span class="p">,</span> <span class="n">templates</span><span class="p">,</span> <span class="n">amplitudes</span><span class="p">,</span> <span class="n">data</span><span class="p">)</span>

    <span class="c1">###</span>
    <span class="c1"># YOUR CODE BELOW</span>
    <span class="c1"># score = F.conv1d(...)</span>
    <span class="c1">###</span>
        
    <span class="k">return</span> <span class="n">score</span>

<span class="n">score</span> <span class="o">=</span> <span class="n">compute_score</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">templates</span><span class="p">,</span> <span class="n">amplitudes</span><span class="p">,</span> <span class="n">data</span><span class="p">)</span>
<span class="k">assert</span> <span class="n">score</span><span class="p">[[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1234</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">]]</span><span class="o">.</span><span class="n">allclose</span><span class="p">(</span><span class="n">solutions</span><span class="p">[</span><span class="s2">&quot;2c&quot;</span><span class="p">],</span> <span class="n">atol</span><span class="o">=</span><span class="mf">1e-4</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
</section>
<section id="problem-2d-update-the-amplitudes-using-find-peaks">
<h3>Problem 2d: Update the amplitudes using <code class="docutils literal notranslate"><span class="pre">find_peaks</span></code><a class="headerlink" href="#problem-2d-update-the-amplitudes-using-find-peaks" title="Permalink to this heading">#</a></h3>
<p>Our next step is to update the amplitudes given the scores. We’ll use a simple heuristic as described in the course notes: use <code class="docutils literal notranslate"><span class="pre">find_peaks</span></code> to find peaks in the score that are separated by a distance of at least <span class="math notranslate nohighlight">\(D\)</span> samples and at least a height of <span class="math notranslate nohighlight">\(\sigma^2 \lambda\)</span>, where <span class="math notranslate nohighlight">\(\sigma\)</span> is the standard deviation of the noise and <span class="math notranslate nohighlight">\(\lambda\)</span> is the amplitude rate hyperparameter.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">_update_amplitude</span><span class="p">(</span><span class="n">neuron</span><span class="p">,</span> <span class="n">templates</span><span class="p">,</span> <span class="n">amplitudes</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> 
                      <span class="n">noise_std</span><span class="o">=</span><span class="mf">1.0</span><span class="p">,</span> <span class="n">amp_rate</span><span class="o">=</span><span class="mf">5.0</span><span class="p">):</span>
    <span class="n">K</span><span class="p">,</span> <span class="n">N</span><span class="p">,</span> <span class="n">D</span> <span class="o">=</span> <span class="n">templates</span><span class="o">.</span><span class="n">shape</span>
    <span class="n">T</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>

    <span class="c1"># Compute the score and convert it to a numpy array.</span>
    <span class="n">score</span> <span class="o">=</span> <span class="n">compute_score</span><span class="p">(</span><span class="n">neuron</span><span class="p">,</span> <span class="n">templates</span><span class="p">,</span> <span class="n">amplitudes</span><span class="p">,</span> <span class="n">data</span><span class="p">)</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="s2">&quot;cpu&quot;</span><span class="p">)</span>
    
    <span class="c1"># Initialize the new amplitudes a_k for this neuron</span>
    <span class="n">new_amplitude</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">T</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="n">device</span><span class="p">)</span>
    
    <span class="c1">###</span>
    <span class="c1"># YOUR CODE BELOW</span>
    
    <span class="c1"># peaks, props = find_peaks(...)</span>
    
    <span class="c1"># Convert the peak heights to a tensor</span>
    <span class="c1"># heights = torch.tensor(props[&#39;peak_heights&#39;], </span>
    <span class="c1">#                        dtype=torch.float32, device=device)</span>

    <span class="c1"># Compute the new amplitude for this neuron.</span>
    <span class="c1"># new_amplitude...</span>
    
    <span class="c1">#</span>
    <span class="c1">###</span>
        
    <span class="k">return</span> <span class="n">new_amplitude</span>
    
<span class="n">amplitudes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">_update_amplitude</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">templates</span><span class="p">,</span> <span class="n">amplitudes</span><span class="p">,</span> <span class="n">data</span><span class="p">)</span>
<span class="k">assert</span> <span class="n">torch</span><span class="o">.</span><span class="n">allclose</span><span class="p">(</span><span class="n">amplitudes</span><span class="p">[</span><span class="mi">0</span><span class="p">][[</span><span class="mi">118</span><span class="p">,</span> <span class="mi">119</span><span class="p">,</span> <span class="mi">467</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">]]</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="s2">&quot;cpu&quot;</span><span class="p">),</span> 
                      <span class="n">solutions</span><span class="p">[</span><span class="s2">&quot;2d&quot;</span><span class="p">])</span>
</pre></div>
</div>
</div>
</div>
</section>
<section id="problem-2e-update-the-templates">
<h3>Problem 2e: Update the templates<a class="headerlink" href="#problem-2e-update-the-templates" title="Permalink to this heading">#</a></h3>
<p>Our last step is to update the template for a given neuron by projecting the <em>target</em> <span class="math notranslate nohighlight">\(\overline{\mathbf{R}} \in \mathbb{R}^{N \times D}\)</span>. The target is the sum of scaled residuals at the times of spikes in the amplitudes:</p>
<div class="math notranslate nohighlight">
\[
\begin{align}
    \overline{\mathbf{R}} = \sum_t a_{k,t} \mathbf{R}_{:,t:t+D}.
\end{align}
\]</div>
<p>where <span class="math notranslate nohighlight">\(\mathbf{R} \in \mathbb{R}^{N \times T}\)</span> denotes the residual for neuron <span class="math notranslate nohighlight">\(n\)</span>.</p>
<p>To get the template, project <span class="math notranslate nohighlight">\(\overline{\mathbf{R}}\)</span> onto <span class="math notranslate nohighlight">\(\mathcal{S}_K^{(N,D)}\)</span>, the set of rank-<span class="math notranslate nohighlight">\(K\)</span>, unit-norm, <span class="math notranslate nohighlight">\(N \times D\)</span> matrices, using the SVD.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">_update_template</span><span class="p">(</span><span class="n">neuron</span><span class="p">,</span> <span class="n">templates</span><span class="p">,</span> <span class="n">amplitudes</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">template_rank</span><span class="o">=</span><span class="mi">1</span><span class="p">):</span>
    <span class="n">K</span><span class="p">,</span> <span class="n">N</span><span class="p">,</span> <span class="n">D</span> <span class="o">=</span> <span class="n">templates</span><span class="o">.</span><span class="n">shape</span>
    <span class="n">T</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>

    <span class="c1"># Initialize the new template</span>
    <span class="n">new_template</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">N</span><span class="p">,</span> <span class="n">D</span><span class="p">),</span> <span class="n">device</span><span class="o">=</span><span class="n">device</span><span class="p">)</span>

    <span class="c1"># Check if the factor is used. If not, generate a random new one.</span>
    <span class="k">if</span> <span class="n">amplitudes</span><span class="p">[</span><span class="n">neuron</span><span class="p">]</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span> <span class="o">&lt;</span> <span class="mi">1</span><span class="p">:</span>
        <span class="n">target</span> <span class="o">=</span> <span class="n">generate_templates</span><span class="p">(</span><span class="n">N</span><span class="p">,</span> <span class="n">D</span><span class="p">,</span> <span class="mi">1</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>

    <span class="k">else</span><span class="p">:</span>
        <span class="c1"># Get the residual using the function you wrote above</span>
        <span class="n">residual</span> <span class="o">=</span> <span class="n">compute_residual</span><span class="p">(</span><span class="n">neuron</span><span class="p">,</span> <span class="n">templates</span><span class="p">,</span> <span class="n">amplitudes</span><span class="p">,</span> <span class="n">data</span><span class="p">)</span>

        <span class="c1">###</span>
        <span class="c1"># YOUR CODE BELOW</span>
        <span class="c1"># target = ...</span>
        <span class="c1">###</span>
        
    <span class="c1">###</span>
    <span class="c1"># Project the target onto the set of normalized rank-K templates using </span>
    <span class="c1"># `torch.svd` and `torch.norm`. Note that `torch.svd` returns V rather </span>
    <span class="c1"># than V^T</span>
    <span class="c1"># YOUR CODE BELOW</span>
    
    <span class="c1"># new_template = ...</span>
    
    <span class="c1">###</span>
    
    <span class="k">return</span> <span class="n">new_template</span>

<span class="c1"># Set amplitudes using previous cell output</span>
<span class="c1"># so the template update code is executed</span>
<span class="n">templates</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">_update_template</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">templates</span><span class="p">,</span> <span class="n">amplitudes</span><span class="p">,</span> <span class="n">data</span><span class="p">)</span>
<span class="k">assert</span> <span class="n">torch</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">templates</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="s1">&#39;fro&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">isclose</span><span class="p">(</span>
    <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">(</span><span class="mf">1.0</span><span class="p">),</span> <span class="n">atol</span><span class="o">=</span><span class="mf">1e-4</span><span class="p">)</span>
<span class="k">assert</span> <span class="n">templates</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">16</span><span class="p">,</span> <span class="mi">44</span><span class="p">]</span><span class="o">.</span><span class="n">isclose</span><span class="p">(</span><span class="n">solutions</span><span class="p">[</span><span class="s2">&quot;2e&quot;</span><span class="p">],</span> <span class="n">atol</span><span class="o">=</span><span class="mf">1e-4</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
</section>
<section id="put-it-all-together">
<h3>Put it all together<a class="headerlink" href="#put-it-all-together" title="Permalink to this heading">#</a></h3>
<p>That’s it! We’ve written a little function to perform coordinate ascent using your <code class="docutils literal notranslate"><span class="pre">_update_*</span></code> functions. It tracks the log likelihood at each iteration. (We’re ignoring the priors for now, but it would be easy to compute those in Problem 2a if you wanted to). It also uses some nice progress bars so you can see how fast (or slow?) your code runs.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">map_estimate</span><span class="p">(</span><span class="n">templates</span><span class="p">,</span> 
                 <span class="n">amplitudes</span><span class="p">,</span> 
                 <span class="n">data</span><span class="p">,</span>
                 <span class="n">num_iters</span><span class="o">=</span><span class="mi">20</span><span class="p">,</span> 
                 <span class="n">template_rank</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
                 <span class="n">noise_std</span><span class="o">=</span><span class="mf">1.0</span><span class="p">,</span> 
                 <span class="n">amp_rate</span><span class="o">=</span><span class="mf">5.0</span><span class="p">,</span>
                 <span class="n">tol</span><span class="o">=</span><span class="mf">1e-4</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Fit the templates and amplitudes by maximum a posteriori (MAP) estimation</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">K</span><span class="p">,</span> <span class="n">N</span><span class="p">,</span> <span class="n">D</span> <span class="o">=</span> <span class="n">templates</span><span class="o">.</span><span class="n">shape</span>

    <span class="c1"># Make fancy reusable progress bars</span>
    <span class="n">outer_pbar</span> <span class="o">=</span> <span class="n">trange</span><span class="p">(</span><span class="n">num_iters</span><span class="p">)</span>
    <span class="n">inner_pbar</span> <span class="o">=</span> <span class="n">trange</span><span class="p">(</span><span class="n">K</span><span class="p">)</span>
    <span class="n">inner_pbar</span><span class="o">.</span><span class="n">set_description</span><span class="p">(</span><span class="s2">&quot;updating neurons&quot;</span><span class="p">)</span>

    <span class="c1"># Track log likelihoods over iterations</span>
    <span class="n">lls</span> <span class="o">=</span> <span class="p">[</span><span class="n">log_likelihood</span><span class="p">(</span><span class="n">templates</span><span class="p">,</span> <span class="n">amplitudes</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">noise_std</span><span class="o">=</span><span class="n">noise_std</span><span class="p">)]</span>
    <span class="k">for</span> <span class="n">itr</span> <span class="ow">in</span> <span class="n">outer_pbar</span><span class="p">:</span>
        <span class="n">inner_pbar</span><span class="o">.</span><span class="n">reset</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">K</span><span class="p">):</span>
            <span class="c1"># Update the amplitude</span>
            <span class="n">amplitudes</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">_update_amplitude</span><span class="p">(</span>
                <span class="n">k</span><span class="p">,</span> <span class="n">templates</span><span class="p">,</span> <span class="n">amplitudes</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> 
                <span class="n">noise_std</span><span class="o">=</span><span class="n">noise_std</span><span class="p">,</span> <span class="n">amp_rate</span><span class="o">=</span><span class="n">amp_rate</span><span class="p">)</span>    
            <span class="c1"># Update the template</span>
            <span class="n">templates</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">_update_template</span><span class="p">(</span>
                <span class="n">k</span><span class="p">,</span> <span class="n">templates</span><span class="p">,</span> <span class="n">amplitudes</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">template_rank</span><span class="o">=</span><span class="n">template_rank</span><span class="p">)</span>
            <span class="n">inner_pbar</span><span class="o">.</span><span class="n">update</span><span class="p">()</span>

        <span class="c1"># Compute the log likelihood </span>
        <span class="n">lls</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">log_likelihood</span><span class="p">(</span><span class="n">templates</span><span class="p">,</span> <span class="n">amplitudes</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> 
                                  <span class="n">noise_std</span><span class="o">=</span><span class="n">noise_std</span><span class="p">))</span>

        <span class="c1"># Check for convergence</span>
        <span class="k">if</span> <span class="nb">abs</span><span class="p">(</span><span class="n">lls</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">lls</span><span class="p">[</span><span class="o">-</span><span class="mi">2</span><span class="p">])</span> <span class="o">&lt;</span> <span class="n">tol</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Convergence detected!&quot;</span><span class="p">)</span>
            <span class="k">break</span>
    
    <span class="k">return</span> <span class="n">torch</span><span class="o">.</span><span class="n">stack</span><span class="p">(</span><span class="n">lls</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
</section>
<section id="fit-the-synthetic-data-and-plot-the-log-likelihoods">
<h3>Fit the synthetic data and plot the log likelihoods<a class="headerlink" href="#fit-the-synthetic-data-and-plot-the-log-likelihoods" title="Permalink to this heading">#</a></h3>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Make random templates and set amplitude to zero</span>
<span class="n">torch</span><span class="o">.</span><span class="n">manual_seed</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
<span class="n">templates</span> <span class="o">=</span> <span class="n">generate_templates</span><span class="p">(</span><span class="n">N</span><span class="p">,</span> <span class="n">D</span><span class="p">,</span> <span class="n">K</span><span class="p">)</span>
<span class="n">amplitudes</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">K</span><span class="p">,</span> <span class="n">T</span><span class="p">),</span> <span class="n">device</span><span class="o">=</span><span class="n">device</span><span class="p">)</span>
<span class="n">noise_std</span> <span class="o">=</span> <span class="mf">1.0</span>     <span class="c1"># \sigma</span>
<span class="n">amp_rate</span> <span class="o">=</span> <span class="mf">5.0</span>      <span class="c1"># \lambda</span>

<span class="c1"># Copy to the device</span>
<span class="n">true_templates</span> <span class="o">=</span> <span class="n">true_templates</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">device</span><span class="p">)</span>
<span class="n">true_amplitudes</span> <span class="o">=</span> <span class="n">true_amplitudes</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">device</span><span class="p">)</span>
<span class="n">templates</span> <span class="o">=</span> <span class="n">templates</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">device</span><span class="p">)</span>
<span class="n">amplitudes</span> <span class="o">=</span> <span class="n">amplitudes</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">device</span><span class="p">)</span>
<span class="n">data</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">device</span><span class="p">)</span>

<span class="c1"># Fit the model.</span>
<span class="n">lls</span> <span class="o">=</span> <span class="n">map_estimate</span><span class="p">(</span><span class="n">templates</span><span class="p">,</span> <span class="n">amplitudes</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> 
                   <span class="n">noise_std</span><span class="o">=</span><span class="n">noise_std</span><span class="p">,</span> 
                   <span class="n">amp_rate</span><span class="o">=</span><span class="n">amp_rate</span><span class="p">)</span>

<span class="c1"># For comparison, compute the log likelihood with the true templates </span>
<span class="c1"># and amplitudes.</span>
<span class="n">true_ll</span> <span class="o">=</span> <span class="n">log_likelihood</span><span class="p">(</span><span class="n">true_templates</span><span class="p">,</span> <span class="n">true_amplitudes</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">noise_std</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<script type="application/vnd.jupyter.widget-view+json">{"model_id": "69383ab814654044a5b8e49d4d8c8e4c", "version_major": 2, "version_minor": 0}</script><script type="application/vnd.jupyter.widget-view+json">{"model_id": "e73e994664cd48138260a0b8daf02c30", "version_major": 2, "version_minor": 0}</script><div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Convergence detected!
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Plot the log likelihoods</span>
<span class="n">lls</span> <span class="o">=</span> <span class="n">lls</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="s2">&quot;cpu&quot;</span><span class="p">)</span>
<span class="n">true_ll</span> <span class="o">=</span> <span class="n">true_ll</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="s2">&quot;cpu&quot;</span><span class="p">)</span>

<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">lls</span><span class="p">,</span> <span class="s1">&#39;-o&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">hlines</span><span class="p">(</span><span class="n">true_ll</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">lls</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> 
           <span class="n">colors</span><span class="o">=</span><span class="s1">&#39;r&#39;</span><span class="p">,</span> <span class="n">linestyles</span><span class="o">=</span><span class="s1">&#39;:&#39;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;true LL&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s2">&quot;Iteration&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlim</span><span class="p">(</span><span class="o">-</span><span class="mf">.1</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">lls</span><span class="p">)</span> <span class="o">-</span> <span class="mf">.9</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s2">&quot;Log Likelihood&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">loc</span><span class="o">=</span><span class="s2">&quot;lower right&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>&lt;matplotlib.legend.Legend at 0x7f7f71086190&gt;
</pre></div>
</div>
<img alt="../_images/bb4593fa401ad39b43373c3a0106e7ba6e13eef0bb1187a794aa076694b86ce5.png" src="../_images/bb4593fa401ad39b43373c3a0106e7ba6e13eef0bb1187a794aa076694b86ce5.png" />
</div>
</div>
</section>
<section id="find-a-permutation-of-the-inferred-neurons-that-best-matches-the-true-neurons">
<h3>Find a permutation of the inferred neurons that best matches the true neurons<a class="headerlink" href="#find-a-permutation-of-the-inferred-neurons-that-best-matches-the-true-neurons" title="Permalink to this heading">#</a></h3>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Compute the similarity (inner product) of the true and inferred templates</span>
<span class="n">similarity</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">K</span><span class="p">,</span> <span class="n">K</span><span class="p">))</span>
<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">K</span><span class="p">):</span>
    <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">K</span><span class="p">):</span>
        <span class="n">similarity</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">true_templates</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">*</span> <span class="n">templates</span><span class="p">[</span><span class="n">j</span><span class="p">])</span>
        
<span class="c1"># Show the similarity matrix</span>
<span class="n">_</span><span class="p">,</span> <span class="n">perm</span> <span class="o">=</span> <span class="n">linear_sum_assignment</span><span class="p">(</span><span class="n">similarity</span><span class="p">,</span> <span class="n">maximize</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">similarity</span><span class="p">[:,</span> <span class="n">perm</span><span class="p">],</span> <span class="n">vmin</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">vmax</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s2">&quot;true neuron&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s2">&quot;inferred neuron&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s2">&quot;similarity of amplitudes&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">colorbar</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>&lt;matplotlib.colorbar.Colorbar at 0x7f7f70759730&gt;
</pre></div>
</div>
<img alt="../_images/adacdf8a831ff2c44fc62da00f9996cd15be2a850e31630ae3fda3c3a9df1861.png" src="../_images/adacdf8a831ff2c44fc62da00f9996cd15be2a850e31630ae3fda3c3a9df1861.png" />
</div>
</div>
</section>
<section id="plot-the-true-and-inferred-templates">
<h3>Plot the true and inferred templates<a class="headerlink" href="#plot-the-true-and-inferred-templates" title="Permalink to this heading">#</a></h3>
<p>They should line up pretty well.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Plot the true and inferred templates, permuted to best match</span>
<span class="n">fig</span><span class="p">,</span> <span class="n">axs</span> <span class="o">=</span> <span class="n">plot_templates</span><span class="p">(</span><span class="n">true_templates</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="s2">&quot;cpu&quot;</span><span class="p">),</span> <span class="n">torch</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">K</span><span class="p">),</span> <span class="n">n_cols</span><span class="o">=</span><span class="n">K</span><span class="p">)</span>
<span class="n">_</span> <span class="o">=</span> <span class="n">plot_templates</span><span class="p">(</span><span class="n">templates</span><span class="p">[</span><span class="n">perm</span><span class="p">]</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="s2">&quot;cpu&quot;</span><span class="p">),</span> 
                   <span class="n">torch</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">K</span><span class="p">),</span> 
                   <span class="n">n_cols</span><span class="o">=</span><span class="n">K</span><span class="p">,</span> 
                   <span class="n">colors</span><span class="o">=</span><span class="p">(</span><span class="s1">&#39;r&#39;</span><span class="p">,),</span> 
                   <span class="n">fig</span><span class="o">=</span><span class="n">fig</span><span class="p">,</span> 
                   <span class="n">axs</span><span class="o">=</span><span class="n">axs</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../_images/940cb9664bcb9535d50236c601166dcd7f8eaf79de2c3d01604a9ccdbd41f418.png" src="../_images/940cb9664bcb9535d50236c601166dcd7f8eaf79de2c3d01604a9ccdbd41f418.png" />
</div>
</div>
</section>
</section>
<section id="part-3-now-do-it-more-efficiently">
<h2>Part 3: Now do it more efficiently<a class="headerlink" href="#part-3-now-do-it-more-efficiently" title="Permalink to this heading">#</a></h2>
<p>Our code above was not optimized for efficiency. For example, we kept recomputing the residual, which incurred costly convolutions. Likewise, we naively cross-correlated the residual with the templates, without leveraging the fact that the templates are low rank. In this section you’ll go back and address these shortcomings.</p>
<section id="problem-3a-write-helper-functions-to-up-down-date-the-residual">
<h3>Problem 3a: Write helper functions to up/down-date the residual<a class="headerlink" href="#problem-3a-write-helper-functions-to-up-down-date-the-residual" title="Permalink to this heading">#</a></h3>
<p>Each iteration of <code class="docutils literal notranslate"><span class="pre">map_estimate</span></code> updates one neuron at a time. We can save a lot of computation by just adding and subtracting that neuron’s convolved template from the residual at the start and end of the iteration. Moreover, we can perform that convolution more efficiently by working directly with the factors of the template.</p>
<p>Let <span class="math notranslate nohighlight">\(\mathbf{W}_k = \mathbf{U}_k \tilde{\mathbf{V}}_k^\top\)</span> where <span class="math notranslate nohighlight">\(\tilde{\mathbf{V}}_k^\top = \mathrm{diag}(\mathbf{s}_k) \mathbf{V}_k^\top \in {R \times D}\)</span> denotes the weighted temporal factors of neuron <span class="math notranslate nohighlight">\(k\)</span>’s template. We can use this factorization to implement the convolution as,</p>
<div class="math notranslate nohighlight">
\[
\begin{align}
\mathbf{a}_k \circledast \mathbf{W}_k = \mathbf{U}_k (\mathbf{a}_k \circledast \tilde{\mathbf{V}}_k^\top)
\end{align}
\]</div>
<p>In code, we’ll let <code class="docutils literal notranslate"><span class="pre">footprints</span></code> denote the tensor of spatial factors. It is of shape <span class="math notranslate nohighlight">\(K \times N \times R\)</span> where <span class="math notranslate nohighlight">\(R\)</span> is the rank, so <code class="docutils literal notranslate"><span class="pre">footprints[k]</span></code> corresponds to <span class="math notranslate nohighlight">\(U_k\)</span> in our equations above. Likewise, let <code class="docutils literal notranslate"><span class="pre">profiles</span></code> denote the tensor of weighted temporal factors.  It is of shape <span class="math notranslate nohighlight">\(K \times R \times D\)</span> so that <code class="docutils literal notranslate"><span class="pre">profiles[k]</span></code> corresponds to <span class="math notranslate nohighlight">\(\tilde{\mathbf{V}}_k^\top\)</span>.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">update_residual</span><span class="p">(</span><span class="n">neuron</span><span class="p">,</span> <span class="n">footprints</span><span class="p">,</span> <span class="n">profiles</span><span class="p">,</span> <span class="n">amplitudes</span><span class="p">,</span> <span class="n">residual</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Add the specified neurons&#39; template convolved with its amplitude </span>
<span class="sd">    to the residual.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">K</span><span class="p">,</span> <span class="n">N</span><span class="p">,</span> <span class="n">R</span> <span class="o">=</span> <span class="n">footprints</span><span class="o">.</span><span class="n">shape</span>
    <span class="n">_</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">D</span> <span class="o">=</span> <span class="n">profiles</span><span class="o">.</span><span class="n">shape</span>
    <span class="n">_</span><span class="p">,</span> <span class="n">T</span> <span class="o">=</span> <span class="n">residual</span><span class="o">.</span><span class="n">shape</span>

    <span class="c1">###</span>
    <span class="c1"># Convolve this neuron&#39;s amplitude with its weighted temporal factor.</span>
    <span class="c1"># Project the result using the neuron&#39;s channel factor.</span>
    <span class="c1"># Add that result to the residual.</span>
    <span class="c1">#</span>
    <span class="c1"># YOUR CODE BELOW</span>
    <span class="c1"># residual += ...</span>
    <span class="c1">#</span>
    <span class="c1">###</span>

<span class="k">def</span> <span class="nf">downdate_residual</span><span class="p">(</span><span class="n">neuron</span><span class="p">,</span> <span class="n">footprints</span><span class="p">,</span> <span class="n">profiles</span><span class="p">,</span> <span class="n">amplitudes</span><span class="p">,</span> <span class="n">residual</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Subtract the specified neurons&#39; template convolved with its amplitude </span>
<span class="sd">    to the residual.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">K</span><span class="p">,</span> <span class="n">N</span><span class="p">,</span> <span class="n">R</span> <span class="o">=</span> <span class="n">footprints</span><span class="o">.</span><span class="n">shape</span>
    <span class="n">_</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">D</span> <span class="o">=</span> <span class="n">profiles</span><span class="o">.</span><span class="n">shape</span>
    <span class="n">_</span><span class="p">,</span> <span class="n">T</span> <span class="o">=</span> <span class="n">residual</span><span class="o">.</span><span class="n">shape</span>

    <span class="c1">###</span>
    <span class="c1"># Convolve this neuron&#39;s amplitude with its weighted temporal factor.</span>
    <span class="c1"># Project the result using the neuron&#39;s channel factor.</span>
    <span class="c1"># Subtract that result to the residual.</span>
    <span class="c1">#</span>
    <span class="c1"># YOUR CODE BELOW</span>
    <span class="c1"># residual -= ...</span>
    <span class="c1">#</span>
    <span class="c1">###</span>
</pre></div>
</div>
</div>
</div>
</section>
<section id="problem-3b-update-the-amplitudes-using-a-fast-score-calculation">
<h3>Problem 3b: Update the amplitudes using a fast score calculation<a class="headerlink" href="#problem-3b-update-the-amplitudes-using-a-fast-score-calculation" title="Permalink to this heading">#</a></h3>
<p>In the course notes, we showed that the score—the cross correlation of the residual and a template— can be computed more efficiently by projecting the residual on the spatial factors of the template and then convolving with the weighted temporal factors. In math,</p>
<div class="math notranslate nohighlight">
\[
\begin{align}
\mathbf{R} \star \mathbf{W}_k &amp;= (\mathbf{U}_k^\top \mathbf{R}) \star \tilde{\mathbf{V}}_k^\top.
\end{align}
\]</div>
<p>Re-implement your <code class="docutils literal notranslate"><span class="pre">update_amplitude</span></code> function from above, but this time compute the score by projecting and convolving the residual.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">_update_amplitude_fast</span><span class="p">(</span><span class="n">neuron</span><span class="p">,</span> <span class="n">footprints</span><span class="p">,</span> <span class="n">profiles</span><span class="p">,</span> <span class="n">amplitudes</span><span class="p">,</span> <span class="n">residual</span><span class="p">,</span> 
                           <span class="n">noise_std</span><span class="o">=</span><span class="mf">1.0</span><span class="p">,</span> <span class="n">amp_rate</span><span class="o">=</span><span class="mf">5.0</span><span class="p">):</span>
    <span class="n">K</span><span class="p">,</span> <span class="n">N</span><span class="p">,</span> <span class="n">R</span> <span class="o">=</span> <span class="n">footprints</span><span class="o">.</span><span class="n">shape</span>
    <span class="n">_</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">D</span> <span class="o">=</span> <span class="n">profiles</span><span class="o">.</span><span class="n">shape</span>
    <span class="n">_</span><span class="p">,</span> <span class="n">T</span> <span class="o">=</span> <span class="n">residual</span><span class="o">.</span><span class="n">shape</span>
    
    <span class="n">new_amplitudes</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">T</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="n">device</span><span class="p">)</span>
    
    <span class="c1">###</span>
    <span class="c1"># compute the score by projecting the residual (U_k^T R_k)</span>
    <span class="c1"># and cross-correlating with the weighted temporal factor (V_k^T)</span>
    <span class="c1"># </span>
    <span class="c1"># YOUR CODE BELOW</span>
    
    <span class="c1"># project the residual onto the channel factor for this neuron</span>
    <span class="c1"># proj_residual = ...     </span>
    
    <span class="c1"># correlate the projected residual with the weighted temporal factor</span>
    <span class="c1"># score = F.conv1d(...).to(&quot;cpu&quot;)</span>
    
    <span class="c1"># Find the peaks in the cross-correlation</span>
    <span class="c1"># peaks, props = find_peaks(...)</span>
    <span class="c1"># heights = torch.tensor(props[&#39;peak_heights&#39;], </span>
    <span class="c1">#                        dtype=torch.float32, device=device)</span>

    <span class="c1"># Update the amplitudes for this neuron in place</span>
    <span class="c1"># new_amplitudes...</span>
    
    <span class="c1">#</span>
    <span class="c1">###</span>

    <span class="k">return</span> <span class="n">new_amplitudes</span>
        
</pre></div>
</div>
</div>
</div>
</section>
<section id="problem-3c-update-the-low-rank-factors-of-the-template">
<h3>Problem 3c: Update the low rank factors of the template<a class="headerlink" href="#problem-3c-update-the-low-rank-factors-of-the-template" title="Permalink to this heading">#</a></h3>
<p>Finally, copy your answer from Problem 2e to update the templates, but this time just keep the template factors <span class="math notranslate nohighlight">\(\mathbf{U}_k\)</span> and <span class="math notranslate nohighlight">\(\tilde{\mathbf{V}}_k^\top\)</span>.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">_update_template_factors</span><span class="p">(</span><span class="n">neuron</span><span class="p">,</span> <span class="n">footprints</span><span class="p">,</span> <span class="n">profiles</span><span class="p">,</span> 
                             <span class="n">amplitudes</span><span class="p">,</span> <span class="n">residual</span><span class="p">,</span> <span class="n">template_rank</span><span class="o">=</span><span class="mi">1</span><span class="p">):</span>
    <span class="n">K</span><span class="p">,</span> <span class="n">N</span><span class="p">,</span> <span class="n">D</span> <span class="o">=</span> <span class="n">templates</span><span class="o">.</span><span class="n">shape</span>
    <span class="n">T</span> <span class="o">=</span> <span class="n">residual</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
    
    <span class="n">new_footprint</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">N</span><span class="p">,</span> <span class="n">template_rank</span><span class="p">))</span>
    <span class="n">new_profile</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">template_rank</span><span class="p">,</span> <span class="n">D</span><span class="p">))</span>

    <span class="c1"># Check if the factor is used. if not, generate a random target.</span>
    <span class="k">if</span> <span class="n">amplitudes</span><span class="p">[</span><span class="n">neuron</span><span class="p">]</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span> <span class="o">&lt;</span> <span class="mi">1</span><span class="p">:</span>
        <span class="n">target</span> <span class="o">=</span> <span class="n">generate_templates</span><span class="p">(</span><span class="n">N</span><span class="p">,</span> <span class="n">D</span><span class="p">,</span> <span class="mi">1</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="c1">###</span>
        <span class="c1"># Compute the target (inner product of residual and regressors)</span>
        <span class="c1"># YOUR CODE BELOW</span>

        <span class="c1"># target = ...</span>
        
        <span class="c1">#</span>
        <span class="c1">###</span>
        <span class="k">pass</span>

    <span class="c1">###</span>
    <span class="c1"># Project the target onto the set of normalized rank-K templates</span>
    <span class="c1"># and keep only the spatial factors (U_n) and the weighted temporal</span>
    <span class="c1"># factors (V_n^T)</span>
    <span class="c1"># </span>
    <span class="c1"># YOUR CODE BELOW</span>
    <span class="c1"># U, S, V = torch.svd(target)</span>
    
    <span class="c1"># Truncate the SVD and normalize the singular values</span>
    
    <span class="c1"># Truncate, weight, and transpose the factors as appropriate</span>
    <span class="c1"># new_footprint = ...</span>
    <span class="c1"># new_profile = ...</span>
    <span class="c1">#</span>
    <span class="c1">###</span>
    
    <span class="k">return</span> <span class="n">new_footprint</span><span class="p">,</span> <span class="n">new_profile</span>
</pre></div>
</div>
</div>
</div>
</section>
<section id="id1">
<h3>Put it all together<a class="headerlink" href="#id1" title="Permalink to this heading">#</a></h3>
<p>Now we’ll write another function to perform MAP estimation using your new-and-improved code. We’ve got to do a little work to initialize the residuals and the templates, but it’s all pretty straightforward.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">map_estimate_fast</span><span class="p">(</span><span class="n">templates</span><span class="p">,</span> 
                      <span class="n">amplitudes</span><span class="p">,</span> 
                      <span class="n">data</span><span class="p">,</span>
                      <span class="n">num_iters</span><span class="o">=</span><span class="mi">20</span><span class="p">,</span> 
                      <span class="n">template_rank</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
                      <span class="n">noise_std</span><span class="o">=</span><span class="mf">1.0</span><span class="p">,</span> 
                      <span class="n">amp_rate</span><span class="o">=</span><span class="mf">5.0</span><span class="p">,</span>
                      <span class="n">tol</span><span class="o">=</span><span class="mf">1e-4</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Fit the templates and amplitudes by maximum a posteriori (MAP) estimation</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">K</span><span class="p">,</span> <span class="n">N</span><span class="p">,</span> <span class="n">D</span> <span class="o">=</span> <span class="n">templates</span><span class="o">.</span><span class="n">shape</span>

    <span class="c1"># Make a fancy reusable progress bar for the inner loops over neurons.</span>
    <span class="n">outer_pbar</span> <span class="o">=</span> <span class="n">trange</span><span class="p">(</span><span class="n">num_iters</span><span class="p">)</span>
    <span class="n">inner_pbar</span> <span class="o">=</span> <span class="n">trange</span><span class="p">(</span><span class="n">K</span><span class="p">)</span>
    <span class="n">inner_pbar</span><span class="o">.</span><span class="n">set_description</span><span class="p">(</span><span class="s2">&quot;updating neurons&quot;</span><span class="p">)</span>

    <span class="c1"># Initialize the residual</span>
    <span class="n">residual</span> <span class="o">=</span> <span class="n">data</span> <span class="o">-</span> <span class="n">F</span><span class="o">.</span><span class="n">conv1d</span><span class="p">(</span><span class="n">amplitudes</span><span class="o">.</span><span class="n">unsqueeze</span><span class="p">(</span><span class="mi">0</span><span class="p">),</span>
                               <span class="n">templates</span><span class="o">.</span><span class="n">permute</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span><span class="o">.</span><span class="n">flip</span><span class="p">(</span><span class="n">dims</span><span class="o">=</span><span class="p">(</span><span class="mi">2</span><span class="p">,)),</span>
                               <span class="n">padding</span><span class="o">=</span><span class="n">D</span><span class="o">-</span><span class="mi">1</span><span class="p">)[</span><span class="mi">0</span><span class="p">,</span> <span class="p">:,</span> <span class="p">:</span><span class="o">-</span><span class="p">(</span><span class="n">D</span><span class="o">-</span><span class="mi">1</span><span class="p">)]</span>

    <span class="c1"># Initialize the template factors</span>
    <span class="n">U</span><span class="p">,</span> <span class="n">S</span><span class="p">,</span> <span class="n">V</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">svd</span><span class="p">(</span><span class="n">templates</span><span class="p">)</span>
    <span class="n">U</span> <span class="o">=</span> <span class="n">U</span><span class="p">[</span><span class="o">...</span><span class="p">,</span> <span class="p">:</span><span class="n">template_rank</span><span class="p">]</span>
    <span class="n">S</span> <span class="o">=</span> <span class="n">S</span><span class="p">[</span><span class="o">...</span><span class="p">,</span> <span class="p">:</span><span class="n">template_rank</span><span class="p">]</span>
    <span class="n">V</span> <span class="o">=</span> <span class="n">V</span><span class="p">[</span><span class="o">...</span><span class="p">,</span> <span class="p">:</span><span class="n">template_rank</span><span class="p">]</span>
    <span class="n">footprints</span> <span class="o">=</span> <span class="n">U</span>
    <span class="n">profiles</span> <span class="o">=</span> <span class="n">V</span> <span class="o">*</span> <span class="n">S</span><span class="o">.</span><span class="n">unsqueeze</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">profiles</span> <span class="o">=</span> <span class="n">profiles</span><span class="o">.</span><span class="n">permute</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>

    <span class="c1"># Track log likelihoods over iterations</span>
    <span class="n">lls</span> <span class="o">=</span> <span class="p">[</span><span class="n">log_likelihood</span><span class="p">(</span><span class="n">templates</span><span class="p">,</span> <span class="n">amplitudes</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">noise_std</span><span class="o">=</span><span class="n">noise_std</span><span class="p">)]</span>

    <span class="c1"># Coordinate ascent</span>
    <span class="k">for</span> <span class="n">itr</span> <span class="ow">in</span> <span class="n">outer_pbar</span><span class="p">:</span>

        <span class="c1"># Update neurons one at a time</span>
        <span class="n">inner_pbar</span><span class="o">.</span><span class="n">reset</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">K</span><span class="p">):</span>
            <span class="c1"># Update the residual in place (add a_k \circledast W_k)</span>
            <span class="n">update_residual</span><span class="p">(</span><span class="n">k</span><span class="p">,</span> <span class="n">footprints</span><span class="p">,</span> <span class="n">profiles</span><span class="p">,</span> <span class="n">amplitudes</span><span class="p">,</span> <span class="n">residual</span><span class="p">)</span>
    
            <span class="c1"># Update the template and amplitude with the residual</span>
            <span class="n">amplitudes</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">_update_amplitude_fast</span><span class="p">(</span>
                <span class="n">k</span><span class="p">,</span> <span class="n">footprints</span><span class="p">,</span> <span class="n">profiles</span><span class="p">,</span> <span class="n">amplitudes</span><span class="p">,</span> <span class="n">residual</span><span class="p">,</span> 
                <span class="n">noise_std</span><span class="o">=</span><span class="n">noise_std</span><span class="p">,</span> <span class="n">amp_rate</span><span class="o">=</span><span class="n">amp_rate</span><span class="p">)</span>
            
            <span class="n">footprints</span><span class="p">[</span><span class="n">k</span><span class="p">],</span> <span class="n">profiles</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">_update_template_factors</span><span class="p">(</span>
                <span class="n">k</span><span class="p">,</span> <span class="n">footprints</span><span class="p">,</span> <span class="n">profiles</span><span class="p">,</span> <span class="n">amplitudes</span><span class="p">,</span> <span class="n">residual</span><span class="p">,</span> 
                <span class="n">template_rank</span><span class="o">=</span><span class="n">template_rank</span><span class="p">)</span>
    
            <span class="c1"># Downdate the residual in place (subtract a_k \circledast W_k)</span>
            <span class="n">downdate_residual</span><span class="p">(</span><span class="n">k</span><span class="p">,</span> <span class="n">footprints</span><span class="p">,</span> <span class="n">profiles</span><span class="p">,</span> <span class="n">amplitudes</span><span class="p">,</span> <span class="n">residual</span><span class="p">)</span>

            <span class="c1"># Step the progress bar</span>
            <span class="n">inner_pbar</span><span class="o">.</span><span class="n">update</span><span class="p">()</span>

        <span class="c1"># Reconstruct the templates in place</span>
        <span class="n">templates</span><span class="p">[:]</span> <span class="o">=</span> <span class="n">footprints</span> <span class="o">@</span> <span class="n">profiles</span>

        <span class="c1"># Compute the log likelihood </span>
        <span class="n">lls</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">log_likelihood</span><span class="p">(</span><span class="n">templates</span><span class="p">,</span> <span class="n">amplitudes</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> 
                                  <span class="n">noise_std</span><span class="o">=</span><span class="n">noise_std</span><span class="p">))</span>

        <span class="c1"># Check for convergence</span>
        <span class="k">if</span> <span class="nb">abs</span><span class="p">(</span><span class="n">lls</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">lls</span><span class="p">[</span><span class="o">-</span><span class="mi">2</span><span class="p">])</span> <span class="o">&lt;</span> <span class="n">tol</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Convergence detected!&quot;</span><span class="p">)</span>
            <span class="k">break</span>
    
    <span class="k">return</span> <span class="n">torch</span><span class="o">.</span><span class="n">stack</span><span class="p">(</span><span class="n">lls</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
</section>
<section id="run-it-on-the-synthetic-data">
<h3>Run it on the synthetic data<a class="headerlink" href="#run-it-on-the-synthetic-data" title="Permalink to this heading">#</a></h3>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Make random templates and set amplitude to zero</span>
<span class="n">torch</span><span class="o">.</span><span class="n">manual_seed</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
<span class="n">templates</span> <span class="o">=</span> <span class="n">generate_templates</span><span class="p">(</span><span class="n">N</span><span class="p">,</span> <span class="n">D</span><span class="p">,</span> <span class="n">K</span><span class="p">)</span>
<span class="n">amplitudes</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">K</span><span class="p">,</span> <span class="n">T</span><span class="p">),</span> <span class="n">device</span><span class="o">=</span><span class="n">device</span><span class="p">)</span>
<span class="n">noise_std</span> <span class="o">=</span> <span class="mf">1.0</span>
<span class="n">amp_rate</span> <span class="o">=</span> <span class="mf">5.0</span>

<span class="c1"># Copy to the device</span>
<span class="n">templates</span> <span class="o">=</span> <span class="n">templates</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">device</span><span class="p">)</span>
<span class="n">amplitudes</span> <span class="o">=</span> <span class="n">amplitudes</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">device</span><span class="p">)</span>
<span class="n">data</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">device</span><span class="p">)</span>

<span class="c1"># Fit the model.</span>
<span class="n">fast_lls</span> <span class="o">=</span> <span class="n">map_estimate_fast</span><span class="p">(</span><span class="n">templates</span><span class="p">,</span> <span class="n">amplitudes</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> 
                             <span class="n">noise_std</span><span class="o">=</span><span class="n">noise_std</span><span class="p">,</span> <span class="n">amp_rate</span><span class="o">=</span><span class="n">amp_rate</span><span class="p">)</span>

<span class="c1"># Plot the log likelihoods from the fast code on top of those from the </span>
<span class="c1"># original code. They should like up exactly since we used the same </span>
<span class="c1"># random seed for initialization.</span>
<span class="n">fast_lls</span> <span class="o">=</span> <span class="n">fast_lls</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="s2">&quot;cpu&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">lls</span><span class="p">,</span> <span class="s1">&#39;-o&#39;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;orig. MAP&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">fast_lls</span><span class="p">,</span> <span class="s1">&#39;--.&#39;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;fast MAP&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">hlines</span><span class="p">(</span><span class="n">true_ll</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">lls</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> 
           <span class="n">colors</span><span class="o">=</span><span class="s1">&#39;r&#39;</span><span class="p">,</span> <span class="n">linestyles</span><span class="o">=</span><span class="s1">&#39;:&#39;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;true LL&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s2">&quot;Iteration&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlim</span><span class="p">(</span><span class="o">-</span><span class="mf">.1</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">lls</span><span class="p">)</span> <span class="o">-</span> <span class="mf">.9</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s2">&quot;Log Likelihood&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">loc</span><span class="o">=</span><span class="s2">&quot;lower right&quot;</span><span class="p">)</span>

<span class="k">assert</span> <span class="n">torch</span><span class="o">.</span><span class="n">allclose</span><span class="p">(</span><span class="n">lls</span><span class="p">,</span> <span class="n">fast_lls</span><span class="p">,</span> <span class="n">atol</span><span class="o">=</span><span class="mf">1e-4</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<script type="application/vnd.jupyter.widget-view+json">{"model_id": "2e7e3a11d92f41bdb5baf0dfcde41cd4", "version_major": 2, "version_minor": 0}</script><script type="application/vnd.jupyter.widget-view+json">{"model_id": "4ca66e18b784438382b237147b6be39f", "version_major": 2, "version_minor": 0}</script><div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Convergence detected!
</pre></div>
</div>
<img alt="../_images/b66a54c93202ca00d3ec142ca5ea4a225c47090eae7c80e687d38a95ddd7bcc8.png" src="../_images/b66a54c93202ca00d3ec142ca5ea4a225c47090eae7c80e687d38a95ddd7bcc8.png" />
</div>
</div>
</section>
</section>
<section id="part-4-try-it-on-more-realistic-data">
<h2>Part 4: Try it on more realistic data<a class="headerlink" href="#part-4-try-it-on-more-realistic-data" title="Permalink to this heading">#</a></h2>
<p>Last but not least, let’s try it on some simulated data from eMouse — the software used to test Kilosort. This is a bit larger: 3.6x more samples and 2x more channels. We’ll also be fitting 10x more neurons. The fast code you wrote in Problem 3 will make a big difference!</p>
</section>
<section id="load-preprocessed-data">
<h2>Load preprocessed data<a class="headerlink" href="#load-preprocessed-data" title="Permalink to this heading">#</a></h2>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Set some constants</span>
<span class="n">data_dict</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="s2">&quot;lab1_data.pt&quot;</span><span class="p">)</span>
<span class="n">sample_freq</span> <span class="o">=</span> <span class="mi">30000</span>           <span class="c1"># sampling frequency</span>
<span class="n">spike_width</span> <span class="o">=</span> <span class="mi">81</span>              <span class="c1"># width of a spike, in samples</span>
<span class="n">plot_slice</span> <span class="o">=</span> <span class="nb">slice</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">6000</span><span class="p">)</span>   <span class="c1"># 200ms window of frames to plot</span>


<span class="c1"># Load the data and plot it</span>
<span class="n">data</span> <span class="o">=</span> <span class="n">data_dict</span><span class="p">[</span><span class="s2">&quot;data&quot;</span><span class="p">]</span>
<span class="n">num_neurons</span> <span class="o">=</span> <span class="n">data_dict</span><span class="p">[</span><span class="s2">&quot;num_neurons&quot;</span><span class="p">]</span>
<span class="n">num_channels</span><span class="p">,</span> <span class="n">num_samples</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">shape</span>
<span class="n">timestamps</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">num_samples</span><span class="p">)</span> <span class="o">/</span> <span class="n">sample_freq</span>
<span class="n">plot_data</span><span class="p">(</span><span class="n">timestamps</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">scale</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span> <span class="n">plot_slice</span><span class="o">=</span><span class="n">plot_slice</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../_images/bb0eabd06f573f4110bd7632fd4cd7d9433f68112ad38323e92d313e7d95d96d.png" src="../_images/bb0eabd06f573f4110bd7632fd4cd7d9433f68112ad38323e92d313e7d95d96d.png" />
</div>
</div>
<section id="fit-the-model-using-the-fast-map-estimation-code-from-part-3">
<h3>Fit the model using the fast MAP estimation code from Part 3<a class="headerlink" href="#fit-the-model-using-the-fast-map-estimation-code-from-part-3" title="Permalink to this heading">#</a></h3>
<p>This should still take about 4.5 minutes when initialized with random templates. You could also initialize with the results from Lab 1; in fact, this is what Kilosort v1 did. (The latest version has a slightly different approach.) If you dare, try running the “slow” code from Part 2. It should be about 20x slower, so you saved an hour by implementing Part 3!</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Initialize the templates randomly</span>
<span class="n">torch</span><span class="o">.</span><span class="n">manual_seed</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
<span class="n">templates</span> <span class="o">=</span> <span class="n">generate_templates</span><span class="p">(</span><span class="n">num_channels</span><span class="p">,</span> <span class="n">spike_width</span><span class="p">,</span> <span class="n">num_neurons</span><span class="p">)</span>

<span class="c1"># Copy to GPU</span>
<span class="n">templates</span> <span class="o">=</span> <span class="n">templates</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">device</span><span class="p">)</span>
<span class="n">amplitudes</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">num_neurons</span><span class="p">,</span> <span class="n">num_samples</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="n">device</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">torch</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
<span class="n">data</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">device</span><span class="p">)</span>

<span class="c1"># Fit the model.</span>
<span class="n">lls</span> <span class="o">=</span> <span class="n">map_estimate_fast</span><span class="p">(</span><span class="n">templates</span><span class="p">,</span> <span class="n">amplitudes</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">noise_std</span><span class="o">=</span><span class="mf">1.0</span><span class="p">,</span> <span class="n">amp_rate</span><span class="o">=</span><span class="mf">10.0</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<script type="application/vnd.jupyter.widget-view+json">{"model_id": "44b5bd26f42249d4947c9a8d59e11212", "version_major": 2, "version_minor": 0}</script><script type="application/vnd.jupyter.widget-view+json">{"model_id": "9cd35cad762a4bb8b0601869f1a5066c", "version_major": 2, "version_minor": 0}</script><div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Convergence detected!
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># # If you dare, run the &quot;slow&quot; code for comparison...</span>
<span class="c1"># templates = templates.to(device)</span>
<span class="c1"># amplitudes = torch.zeros(num_neurons, num_samples, device=device, dtype=torch.float32)</span>
<span class="c1"># data = data.to(device)</span>
<span class="c1"># lls = map_estimate(templates, amplitudes, data, noise_std=1.0, amp_rate=10.0)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Get the results off the GPU</span>
<span class="n">lls</span> <span class="o">=</span> <span class="n">lls</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="s2">&quot;cpu&quot;</span><span class="p">)</span>
<span class="n">templates</span> <span class="o">=</span> <span class="n">templates</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="s2">&quot;cpu&quot;</span><span class="p">)</span>
<span class="n">amplitudes</span> <span class="o">=</span> <span class="n">amplitudes</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="s2">&quot;cpu&quot;</span><span class="p">)</span>
<span class="n">data</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="s2">&quot;cpu&quot;</span><span class="p">)</span>

<span class="c1"># Plot the log likelihoods</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">lls</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="s2">&quot;cpu&quot;</span><span class="p">),</span> <span class="s1">&#39;-o&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s2">&quot;Iteration&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlim</span><span class="p">(</span><span class="o">-</span><span class="mf">.1</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">lls</span><span class="p">)</span> <span class="o">-</span> <span class="mf">.9</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s2">&quot;Log Likelihood&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../_images/f44772bc202287a44245c278f7f22aa317988dbd9d6e878a89713d86195f7a4d.png" src="../_images/f44772bc202287a44245c278f7f22aa317988dbd9d6e878a89713d86195f7a4d.png" />
</div>
</div>
</section>
<section id="plot-the-inferred-templates">
<h3>Plot the inferred templates<a class="headerlink" href="#plot-the-inferred-templates" title="Permalink to this heading">#</a></h3>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Plot some templates (note, they&#39;re not ordered in any way)</span>
<span class="n">_</span> <span class="o">=</span> <span class="n">plot_templates</span><span class="p">(</span><span class="n">templates</span><span class="p">,</span> <span class="n">torch</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">16</span><span class="p">))</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../_images/24e93f283595d4c0ec2a945d3d68858e20978f88d9ffae720c30e68b93b5c702.png" src="../_images/24e93f283595d4c0ec2a945d3d68858e20978f88d9ffae720c30e68b93b5c702.png" />
</div>
</div>
</section>
<section id="plot-the-data-with-inferred-spikes-overlaid">
<h3>Plot the data with inferred spikes overlaid<a class="headerlink" href="#plot-the-data-with-inferred-spikes-overlaid" title="Permalink to this heading">#</a></h3>
<p>This doesn’t show the ground truth, but you should see that the algorithm has picked up the major spikes in the voltage, and it has assigned similar spikes to the same neuron (colors).</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Find the spike times and neuron labels</span>
<span class="n">spike_times</span> <span class="o">=</span> <span class="p">[]</span>
<span class="n">labels</span> <span class="o">=</span> <span class="p">[]</span>
<span class="k">for</span> <span class="n">neuron</span> <span class="ow">in</span> <span class="n">trange</span><span class="p">(</span><span class="n">num_neurons</span><span class="p">):</span>
    <span class="n">times</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">amplitudes</span><span class="p">[</span><span class="n">neuron</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">spike_times</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">times</span><span class="p">)</span>
    <span class="n">labels</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">neuron</span> <span class="o">*</span> <span class="n">torch</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">times</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">int</span><span class="p">))</span>

<span class="n">spike_times</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">cat</span><span class="p">(</span><span class="n">spike_times</span><span class="p">)</span>
<span class="n">labels</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">cat</span><span class="p">(</span><span class="n">labels</span><span class="p">)</span>

<span class="c1"># Find the channels that are significantly modulated in each template</span>
<span class="n">neuron_channels</span> <span class="o">=</span> <span class="p">[]</span>
<span class="k">for</span> <span class="n">template</span> <span class="ow">in</span> <span class="n">templates</span><span class="p">:</span>
    <span class="n">thresh</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">quantile</span><span class="p">(</span><span class="nb">abs</span><span class="p">(</span><span class="n">template</span><span class="p">),</span> <span class="mf">0.975</span><span class="p">)</span>
    <span class="n">neuron_channels</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">any</span><span class="p">(</span><span class="nb">abs</span><span class="p">(</span><span class="n">template</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">thresh</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">))</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Found </span><span class="si">{}</span><span class="s2"> putative spikes&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">spike_times</span><span class="p">)))</span>

<span class="c1"># Plot the data and overlay the inferred spikes</span>
<span class="n">plot_data</span><span class="p">(</span><span class="n">timestamps</span><span class="p">,</span> 
          <span class="n">data</span><span class="p">,</span> 
          <span class="n">labels</span><span class="o">=</span><span class="n">labels</span><span class="p">,</span> 
          <span class="n">spike_times</span><span class="o">=</span><span class="n">spike_times</span><span class="p">,</span> 
          <span class="n">neuron_channels</span><span class="o">=</span><span class="n">neuron_channels</span><span class="p">,</span> 
          <span class="n">spike_width</span><span class="o">=</span><span class="n">spike_width</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<script type="application/vnd.jupyter.widget-view+json">{"model_id": "9b4d89dbef66400cb43f4d7a08ba1827", "version_major": 2, "version_minor": 0}</script><div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Found 91369 putative spikes
</pre></div>
</div>
<img alt="../_images/1d90f810ba456782e25937ce5fffce08f3e3ad72a4fde9cf617a03b3c058db1b.png" src="../_images/1d90f810ba456782e25937ce5fffce08f3e3ad72a4fde9cf617a03b3c058db1b.png" />
</div>
</div>
</section>
</section>
<section id="part-5-short-answer">
<h2>Part 5: Short Answer<a class="headerlink" href="#part-5-short-answer" title="Permalink to this heading">#</a></h2>
<section id="problem-5a">
<h3>Problem 5a:<a class="headerlink" href="#problem-5a" title="Permalink to this heading">#</a></h3>
<p>In practice, you would post-process the extracted spikes to reject unrealistic neurons and merge overlapping ones. How would you approach this problem?</p>
<p><em>Your answer here</em></p>
</section>
<section id="problem-5b">
<h3>Problem 5b:<a class="headerlink" href="#problem-5b" title="Permalink to this heading">#</a></h3>
<p>Over the course of a long recording session, the probe could drift up and down so that the channels activated by a neuron shift. How could you compensate for this slow drift in this model, or possibly try to correct for it during preprocessing?</p>
<p><em>Your answer here</em></p>
</section>
<section id="problem-5c">
<h3>Problem 5c<a class="headerlink" href="#problem-5c" title="Permalink to this heading">#</a></h3>
<p>You may have noticed that we cheated in parts 2 and 3! We initialized our templates with the same random seed that was used to generate the synthetic data. What happens if you change that random seed? Can you come up with a heuristic to initialize the templates (without cheating and using the same random seed)?</p>
<p><em>Your answer here</em></p>
</section>
<section id="problem-5d">
<h3>Problem 5d<a class="headerlink" href="#problem-5d" title="Permalink to this heading">#</a></h3>
<p>How would your amplitude updates change if we replaced the exponential prior with a truncated normal prior,</p>
<div class="math notranslate nohighlight">
\[
\begin{align*}
p(a_{k,t}) \propto \mathbb{I}[a_{k,t} \geq 0] \, \mathcal{N}(a_{k,t}; \mu, \nu^2).
\end{align*}
\]</div>
<p>Would this prior also shrink the estimates of the amplitude, and if so, how?</p>
<p><em>Your answer here</em></p>
</section>
</section>
<section id="submission-instructions">
<h2>Submission instructions<a class="headerlink" href="#submission-instructions" title="Permalink to this heading">#</a></h2>
<p><strong>Formatting:</strong> check that your code does not exceed 80 characters in line width. You can set <em>Tools → Settings → Editor → Vertical ruler column</em> to 80 to see when you’ve exceeded the limit.</p>
<p>Download your notebook in .ipynb format and use the following commands to convert it to PDF.</p>
<p><strong>Option 1 (best case): ipynb → pdf</strong> Run the following command to convert to a PDF:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">jupyter</span> <span class="n">nbconvert</span> <span class="o">--</span><span class="n">to</span> <span class="n">pdf</span> <span class="n">lab1_teamname</span><span class="o">.</span><span class="n">ipynb</span>
</pre></div>
</div>
<p>Unfortunately, <code class="docutils literal notranslate"><span class="pre">nbconvert</span></code> sometimes crashes with long notebooks. If that happens, here are a few options:</p>
<p><strong>Option 2 (next best): ipynb → tex → pdf</strong>:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">jupyter</span> <span class="n">nbconvert</span> <span class="o">--</span><span class="n">to</span> <span class="n">latex</span> <span class="n">lab1_teamname</span><span class="o">.</span><span class="n">ipynb</span>
<span class="n">pdflatex</span> <span class="n">lab1_teamname</span><span class="o">.</span><span class="n">tex</span>
</pre></div>
</div>
<p><strong>Option 3: ipynb → html → pdf</strong>:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">jupyter</span> <span class="n">nbconvert</span> <span class="o">--</span><span class="n">to</span> <span class="n">html</span> <span class="n">lab1_teamname</span><span class="o">.</span><span class="n">ipynb</span>
<span class="c1"># open lab1_teamname.html in browser and print to pdf</span>
</pre></div>
</div>
<p><strong>Dependencies:</strong></p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">nbconvert</span></code>: If you’re using Anaconda for package management,</p></li>
</ul>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">conda</span> <span class="n">install</span> <span class="o">-</span><span class="n">c</span> <span class="n">anaconda</span> <span class="n">nbconvert</span>
</pre></div>
</div>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">pdflatex</span></code>: It comes with standard TeX distributions like TeXLive, MacTex, etc. Alternatively, you can upload the .tex and supporting files to Overleaf (free with Stanford address) and use it to compile to pdf.</p></li>
</ul>
<p><strong>Upload</strong> your .ipynb and .pdf files to Gradescope.</p>
<p><strong>Only one submission per team!</strong></p>
</section>
</section>

    <script type="text/x-thebe-config">
    {
        requestKernel: true,
        binderOptions: {
            repo: "binder-examples/jupyter-stacks-datascience",
            ref: "master",
        },
        codeMirrorConfig: {
            theme: "abcdef",
            mode: "python"
        },
        kernelOptions: {
            name: "python3",
            path: "./labs"
        },
        predefinedOutput: true
    }
    </script>
    <script>kernelName = 'python3'</script>

                </article>
              

              
              
                <footer class="bd-footer-article">
                  <!-- Previous / next buttons -->
<div class="prev-next-area">
    <a class="left-prev"
       href="00_pytorch_primer.html"
       title="previous page">
      <i class="fa-solid fa-angle-left"></i>
      <div class="prev-next-info">
        <p class="prev-next-subtitle">previous</p>
        <p class="prev-next-title">Lab 0: PyTorch Primer</p>
      </div>
    </a>
    <a class="right-next"
       href="02_calcium_imaging.html"
       title="next page">
      <div class="prev-next-info">
        <p class="prev-next-subtitle">next</p>
        <p class="prev-next-title">Lab 2: Calcium Deconvolution</p>
      </div>
      <i class="fa-solid fa-angle-right"></i>
    </a>
</div>
                </footer>
              
            </div>
            
            
              
                <div class="bd-sidebar-secondary bd-toc"><div class="sidebar-secondary-items sidebar-secondary__inner">

  <div class="sidebar-secondary-item">
  <div class="page-toc tocsection onthispage">
    <i class="fa-solid fa-list"></i> Contents
  </div>
  <nav class="bd-toc-nav page-toc">
    <ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#environment-setup">Environment Setup</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#helper-functions">Helper Functions</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#part-1-convolution-and-cross-correlation-with-pytorch">Part 1: Convolution and cross-correlation with PyTorch</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#problem-1a-perform-a-1d-convolution">Problem 1a: Perform a 1d convolution</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#problem-1b-perform-a-1d-cross-correlation-in-pytorch">Problem 1b: Perform a 1d cross-correlation in PyTorch</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#problem-1c-perform-a-1d-convolution-across-multiple-channels-at-once">Problem 1c: Perform a 1d convolution across multiple channels at once</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#problem-1d-perform-a-1d-cross-correlation-across-multiple-channels-at-once">Problem 1d: Perform a 1d cross-correlation across multiple channels at once</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#problem-1e-convolving-multiple-neurons-spikes-and-templates">Problem 1e: Convolving multiple neurons’ spikes and templates</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#problem-1f-perform-a-1d-cross-correlation-across-multiple-channels-and-neurons-at-once">Problem 1f: Perform a 1d cross-correlation across multiple channels and neurons at once</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#part-2-spike-sorting-by-deconvolution">Part 2: Spike sorting by deconvolution</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#simulate-some-data">Simulate some data</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#problem-2a-compute-the-log-likelihood">Problem 2a: Compute the log likelihood</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#problem-2b-compute-the-residual">Problem 2b: Compute the residual</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#problem-2c-compute-the-score">Problem 2c: Compute the score</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#problem-2d-update-the-amplitudes-using-find-peaks">Problem 2d: Update the amplitudes using <code class="docutils literal notranslate"><span class="pre">find_peaks</span></code></a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#problem-2e-update-the-templates">Problem 2e: Update the templates</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#put-it-all-together">Put it all together</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#fit-the-synthetic-data-and-plot-the-log-likelihoods">Fit the synthetic data and plot the log likelihoods</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#find-a-permutation-of-the-inferred-neurons-that-best-matches-the-true-neurons">Find a permutation of the inferred neurons that best matches the true neurons</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#plot-the-true-and-inferred-templates">Plot the true and inferred templates</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#part-3-now-do-it-more-efficiently">Part 3: Now do it more efficiently</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#problem-3a-write-helper-functions-to-up-down-date-the-residual">Problem 3a: Write helper functions to up/down-date the residual</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#problem-3b-update-the-amplitudes-using-a-fast-score-calculation">Problem 3b: Update the amplitudes using a fast score calculation</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#problem-3c-update-the-low-rank-factors-of-the-template">Problem 3c: Update the low rank factors of the template</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#id1">Put it all together</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#run-it-on-the-synthetic-data">Run it on the synthetic data</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#part-4-try-it-on-more-realistic-data">Part 4: Try it on more realistic data</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#load-preprocessed-data">Load preprocessed data</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#fit-the-model-using-the-fast-map-estimation-code-from-part-3">Fit the model using the fast MAP estimation code from Part 3</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#plot-the-inferred-templates">Plot the inferred templates</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#plot-the-data-with-inferred-spikes-overlaid">Plot the data with inferred spikes overlaid</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#part-5-short-answer">Part 5: Short Answer</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#problem-5a">Problem 5a:</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#problem-5b">Problem 5b:</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#problem-5c">Problem 5c</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#problem-5d">Problem 5d</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#submission-instructions">Submission instructions</a></li>
</ul>
  </nav></div>

</div></div>
              
            
          </div>
          <footer class="bd-footer-content">
            <div class="bd-footer-content__inner">
<div class="bd-footer-content__inner container">
  
  <div class="footer-item">
    
<p class="component-author">
By Scott Linderman
</p>

  </div>
  
  <div class="footer-item">
    
  <p class="copyright">
    
      © Copyright 2022.
      <br/>
    
  </p>

  </div>
  
  <div class="footer-item">
    
  </div>
  
  <div class="footer-item">
    
  </div>
  
</div></div>
          </footer>
        

      </main>
    </div>
  </div>
  
  <!-- Scripts loaded after <body> so the DOM is not blocked -->
  <script src="../_static/scripts/bootstrap.js?digest=12da95d707ffb74b382d"></script>
<script src="../_static/scripts/pydata-sphinx-theme.js?digest=12da95d707ffb74b382d"></script>

  <footer class="bd-footer">
  </footer>
  </body>
</html>